<!DOCTYPE html>
<html>

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QLKC35PVJB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-QLKC35PVJB");
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SendSage | Onboarding</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32"
    href="{{ url_for('static', filename='images/brand/favicon-32x32.png') }}" />
  <link rel="icon" type="image/png" sizes="16x16"
    href="{{ url_for('static', filename='images/brand/favicon-16x16.png') }}" />
  <link rel="apple-touch-icon" sizes="180x180"
    href="{{ url_for('static', filename='images/brand/apple-touch-icon.png') }}" />

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <script src="{{ url_for('static', filename='js/userManagement.js') }}"></script>
  <style>
    .summary-section {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }

    .summary-section h3 {
      color: #333;
      margin-bottom: 15px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .metric-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      cursor: pointer;
    }

    .metric-item.unspecified {
      background-color: #ffebee;
    }

    .metric-item.editable:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .metric-item.editable::after {
      content: '\f044';
      font-family: 'Font Awesome 5 Free';
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .metric-item.editable:hover::after {
      opacity: 0.5;
    }

    .metric-item.editing {
      background-color: #e3f2fd;
    }

    .edit-form {
      display: none;
      margin-top: 10px;
    }

    .edit-form.active {
      display: block;
    }

    .edit-form input[type="text"],
    .edit-form input[type="number"],
    .edit-form select,
    .edit-form textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .edit-form textarea {
      min-height: 80px;
      resize: vertical;
    }

    .edit-form .checkbox-group {
      margin: 10px 0;
    }

    .edit-form label {
      display: block;
      margin-bottom: 5px;
      color: #666;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .save-btn,
    .cancel-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .save-btn {
      background-color: #4caf50;
      color: white;
    }

    .cancel-btn {
      background-color: #f44336;
      color: white;
    }

    .submit-form-btn {
      display: block;
      width: 200px;
      margin: 20px auto;
      padding: 12px 24px;
      background-color: #2196f3;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .submit-form-btn:hover {
      background-color: #1976d2;
    }

    .submit-form-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .metric-label {
      font-weight: 500;
      color: #666;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 1.1em;
      color: #333;
    }

    .projects-list,
    .routes-list {
      list-style: none;
      padding: 0;
    }

    .projects-list li,
    .routes-list li {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .grade-pyramid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .grade-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>

<body>
  <header>
    <a href="{{ url_for('userviz', userId=userId) }}" class="home-link" title="Back to Dashboard">
      <i class="fas fa-home"></i>
    </a>
    <h1>Welcome to SendSage</h1>
    <a href="https://www.buymeacoffee.com/irubey" class="buy-coffee-button" target="_blank">
      <i class="fas fa-coffee"></i> Did I Bring You a Smile?
    </a>
  </header>

  <main class="main-content">
    <div class="container">
      <script>
        const climberSummary = {{ climber_summary| tojson | safe }};
        console.log(climberSummary);
      </script>

      <!-- Core Progression Section -->
      <section class="summary-section">
        <h3>Core Progression</h3>
        <div class="summary-grid">
          <div class="metric-item">
            <div class="metric-label">Years Climbing Outside</div>
            <div class="metric-value" id="yearsClimbing"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Total Climbs</div>
            <div class="metric-value" id="totalClimbs"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Favorite Discipline</div>
            <div class="metric-value" id="favoriteDiscipline"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Preferred Crag (Last Year)</div>
            <div class="metric-value" id="preferredCrag"></div>
          </div>
          <div class="form-group">
            <label for="preferred_crag_last_year">Preferred Crag (Last Year)</label>
            <input type="text" 
                   id="preferred_crag_last_year" 
                   name="preferred_crag_last_year" 
                   value="{{ initial_summary.preferred_crag_last_year or '' }}"
                   class="form-control"
                   placeholder="e.g., Clear Creek Canyon, Boulder Canyon, etc.">
          </div>
          <div class="form-group">
            <label for="total_climbs">Total Climbs</label>
            <input type="number" 
                   id="total_climbs" 
                   name="total_climbs" 
                   value="{{ initial_summary.total_climbs or '' }}"
                   class="form-control"
                   min="0"
                   placeholder="Approximate number of climbs completed">
          </div>
        </div>
      </section>

      <!-- Performance Metrics Section -->
      <section class="summary-section">
        <h3>Performance Metrics</h3>
        <div class="summary-grid">
          <div class="metric-item">
            <div class="metric-label">Highest Sport Lead</div>
            <div class="metric-value" id="highestSportLead"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Highest Trad Lead</div>
            <div class="metric-value" id="highestTradLead"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Highest Boulder</div>
            <div class="metric-value" id="highestBoulder"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Sport Onsight</div>
            <div class="metric-value" id="sportOnsight"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Trad Onsight</div>
            <div class="metric-value" id="tradOnsight"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Boulder Flash</div>
            <div class="metric-value" id="boulderFlash"></div>
          </div>
        </div>
      </section>

      <!-- Style Preferences Section -->
      <section class="summary-section">
        <h3>Style Preferences</h3>
        <div class="summary-grid">
          <div class="metric-item editable" onclick="toggleEdit(this, 'angles')">
            <div class="metric-label">Angles</div>
            <div class="metric-value">
              <div id="favoriteAngle"></div>
              <div id="strongestAngle"></div>
              <div id="weakestAngle"></div>
            </div>
            <div class="edit-form">
              <select onchange="updateFormValue('favorite_angle', this.value)">
                <option value="">Select Favorite Angle</option>
                <option value="SLAB">Slab</option>
                <option value="VERTICAL">Vertical</option>
                <option value="SLIGHT_OVERHANG">Slight Overhang</option>
                <option value="STEEP">Steep</option>
                <option value="ROOF">Roof</option>
              </select>
              <select onchange="updateFormValue('strongest_angle', this.value)">
                <option value="">Select Strongest Angle</option>
                <option value="SLAB">Slab</option>
                <option value="VERTICAL">Vertical</option>
                <option value="SLIGHT_OVERHANG">Slight Overhang</option>
                <option value="STEEP">Steep</option>
                <option value="ROOF">Roof</option>
              </select>
              <select onchange="updateFormValue('weakest_angle', this.value)">
                <option value="">Select Weakest Angle</option>
                <option value="SLAB">Slab</option>
                <option value="VERTICAL">Vertical</option>
                <option value="SLIGHT_OVERHANG">Slight Overhang</option>
                <option value="STEEP">Steep</option>
                <option value="ROOF">Roof</option>
              </select>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'holds')">
            <div class="metric-label">Hold Types</div>
            <div class="metric-value">
              <div id="favoriteHoldTypes"></div>
              <div id="strongestHoldTypes"></div>
              <div id="weakestHoldTypes"></div>
            </div>
            <div class="edit-form">
              <select onchange="updateFormValue('favorite_hold_types', this.value)">
                <option value="">Select Favorite Hold Type</option>
                <option value="CRIMPS">Crimps</option>
                <option value="SLOPERS">Slopers</option>
                <option value="POCKETS">Pockets</option>
                <option value="PINCHES">Pinches</option>
                <option value="JUGS">Jugs</option>
                <option value="CRACKS">Cracks</option>
              </select>
              <select onchange="updateFormValue('strongest_hold_types', this.value)">
                <option value="">Select Strongest Hold Type</option>
                <option value="CRIMPS">Crimps</option>
                <option value="SLOPERS">Slopers</option>
                <option value="POCKETS">Pockets</option>
                <option value="PINCHES">Pinches</option>
                <option value="JUGS">Jugs</option>
                <option value="CRACKS">Cracks</option>
              </select>
              <select onchange="updateFormValue('weakest_hold_types', this.value)">
                <option value="">Select Weakest Hold Type</option>
                <option value="CRIMPS">Crimps</option>
                <option value="SLOPERS">Slopers</option>
                <option value="POCKETS">Pockets</option>
                <option value="PINCHES">Pinches</option>
                <option value="JUGS">Jugs</option>
                <option value="CRACKS">Cracks</option>
              </select>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'energy')">
            <div class="metric-label">Energy Types</div>
            <div class="metric-value">
              <div id="favoriteEnergyType"></div>
              <div id="strongestEnergyType"></div>
              <div id="weakestEnergyType"></div>
            </div>
            <div class="edit-form">
              <select onchange="updateFormValue('favorite_energy_type', this.value)">
                <option value="">Select Favorite Energy Type</option>
                <option value="POWER">Power</option>
                <option value="ENDURANCE">Endurance</option>
                <option value="POWER_ENDURANCE">Power Endurance</option>
                <option value="TECHNICAL">Technical</option>
              </select>
              <select onchange="updateFormValue('strongest_energy_type', this.value)">
                <option value="">Select Strongest Energy Type</option>
                <option value="POWER">Power</option>
                <option value="ENDURANCE">Endurance</option>
                <option value="POWER_ENDURANCE">Power Endurance</option>
                <option value="TECHNICAL">Technical</option>
              </select>
              <select onchange="updateFormValue('weakest_energy_type', this.value)">
                <option value="">Select Weakest Energy Type</option>
                <option value="POWER">Power</option>
                <option value="ENDURANCE">Endurance</option>
                <option value="POWER_ENDURANCE">Power Endurance</option>
                <option value="TECHNICAL">Technical</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Activity Section -->
      <section class="summary-section">
        <h3>Recent Activity</h3>
        <div class="summary-grid">
          <div class="metric-item">
            <div class="metric-label">Sends (Last 30 Days)</div>
            <div class="metric-value" id="recentSends"></div>
          </div>
          <div class="metric-item">
            <div class="metric-label">Current Projects</div>
            <ul class="projects-list" id="currentProjects"></ul>
          </div>
        </div>
      </section>

      <!-- Training Context Section -->
      <section class="summary-section">
        <h3>Training Context</h3>
        <div class="summary-grid">
          <div class="metric-item editable" onclick="toggleEdit(this, 'training')">
            <div class="metric-label">Training Frequency</div>
            <div class="metric-value" id="trainingFrequency"></div>
            <div class="edit-form">
              <select onchange="updateFormValue('training_frequency', this.value)">
                <option value="">Select Frequency</option>
                <option value="ONCE_WEEK">Once per Week</option>
                <option value="TWICE_WEEK">Twice per Week</option>
                <option value="THREE_TIMES_WEEK">Three Times per Week</option>
                <option value="FOUR_PLUS_WEEK">Four or More Times per Week</option>
              </select>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'session')">
            <div class="metric-label">Session Length</div>
            <div class="metric-value" id="sessionLength"></div>
            <div class="edit-form">
              <select onchange="updateFormValue('typical_session_length', this.value)">
                <option value="">Select Length</option>
                <option value="LESS_THAN_ONE_HOUR">Less than 1 Hour</option>
                <option value="ONE_TO_TWO_HOURS">1-2 Hours</option>
                <option value="TWO_TO_THREE_HOURS">2-3 Hours</option>
                <option value="THREE_PLUS_HOURS">3+ Hours</option>
              </select>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'equipment')">
            <div class="metric-label">Equipment</div>
            <div class="metric-value" id="equipment"></div>
            <div class="edit-form">
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" onchange="updateFormValue('has_hangboard', this.checked)"> Has Hangboard
                </label>
              </div>
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" onchange="updateFormValue('has_home_wall', this.checked)"> Has Home Wall
                </label>
              </div>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'indoor')">
            <div class="metric-label">Indoor Training</div>
            <div class="metric-value" id="indoorTraining"></div>
            <div class="edit-form">
              <div class="checkbox-group">
                <label>
                  <input type="checkbox" onchange="updateFormValue('willing_to_train_indoors', this.checked)"> Willing
                  to Train Indoors
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Health & Goals Section -->
      <section class="summary-section">
        <h3>Health & Goals</h3>
        <div class="summary-grid">
          <div class="metric-item editable" onclick="toggleEdit(this, 'injuries')">
            <div class="metric-label">Current Injuries</div>
            <div class="metric-value" id="currentInjuries"></div>
            <div class="edit-form">
              <textarea placeholder="Describe any current injuries..."
                onchange="updateFormValue('current_injuries', this.value)"></textarea>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'injury-history')">
            <div class="metric-label">Injury History</div>
            <div class="metric-value" id="injuryHistory"></div>
            <div class="edit-form">
              <textarea placeholder="Describe your injury history..."
                onchange="updateFormValue('injury_history', this.value)"></textarea>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'limitations')">
            <div class="metric-label">Physical Limitations</div>
            <div class="metric-value" id="physicalLimitations"></div>
            <div class="edit-form">
              <textarea placeholder="Describe any physical limitations..."
                onchange="updateFormValue('physical_limitations', this.value)"></textarea>
            </div>
          </div>
          <div class="metric-item editable" onclick="toggleEdit(this, 'goals')">
            <div class="metric-label">Climbing Goals</div>
            <div class="metric-value" id="climbingGoals"></div>
            <div class="edit-form">
              <textarea placeholder="What are your climbing goals?"
                onchange="updateFormValue('climbing_goals', this.value)"></textarea>
            </div>
          </div>
        </div>
      </section>

      <!-- Preferences Section -->
      <section class="summary-section">
        <h3>Preferences</h3>
        <div class="summary-grid">
          <div class="metric-item editable" onclick="toggleEdit(this, 'climbing-days')">
            <div class="metric-label">Preferred Climbing Days</div>
            <div class="metric-value" id="preferredDays"></div>
            <div class="edit-form">
              <input type="text" placeholder="e.g., Weekends, Tuesday/Thursday..."
                onchange="updateFormValue('preferred_climbing_days', this.value)">
            </div>
          </div>
        </section>

        <!-- Lifestyle -->
        <div class="form-section">
            <h4>Lifestyle</h4>
            <div class="form-group">
                <label for="sleep_score">Sleep Quality</label>
                <div class="table-radio-group">
                    {% set scores = ['POOR', 'FAIR', 'GOOD', 'EXCELLENT'] %}
                    {% for score in scores %}
                        <label>
                            <input type="radio" 
                                   name="sleep_score" 
                                   value="{{ score }}" 
                                   {% if initial_summary.sleep_score and initial_summary.sleep_score.name == score %}checked{% endif %}>
                            <span>{{ score | title }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label for="nutrition_score">Nutrition Quality</label>
                <div class="table-radio-group">
                    {% for score in scores %}
                        <label>
                            <input type="radio" 
                                   name="nutrition_score" 
                                   value="{{ score }}" 
                                   {% if initial_summary.nutrition_score and initial_summary.nutrition_score.name == score %}checked{% endif %}>
                            <span>{{ score | title }}</span>
                        </label>
                    {% endfor %}
                </div>
            </div>
        </div>

      <!-- Submit Button -->
      <button id="submitFormBtn" class="submit-form-btn" onclick="submitForm()">
        Save Profile Updates
      </button>

      <!-- Hidden Form for User Inputs -->
      <form id="climberDataForm" style="display: none;">
        <!-- Core progression metrics -->
        <input type="hidden" name="highest_sport_grade_tried" id="form_highest_sport_grade_tried">
        <input type="hidden" name="highest_trad_grade_tried" id="form_highest_trad_grade_tried">
        <input type="hidden" name="highest_boulder_grade_tried" id="form_highest_boulder_grade_tried">
        <input type="hidden" name="total_climbs" id="form_total_climbs">
        <input type="hidden" name="favorite_discipline" id="form_favorite_discipline">
        <input type="hidden" name="years_climbing_outside" id="form_years_climbing_outside">
        <input type="hidden" name="preferred_crag_last_year" id="form_preferred_crag_last_year">
        
        <!-- Training context -->
        <input type="hidden" name="training_frequency" id="form_training_frequency">
        <input type="hidden" name="typical_session_length" id="form_typical_session_length">
        <input type="hidden" name="has_hangboard" id="form_has_hangboard">
        <input type="hidden" name="has_home_wall" id="form_has_home_wall">
        <input type="hidden" name="goes_to_gym" id="form_goes_to_gym">
        
        <!-- Performance metrics -->
        <input type="hidden" name="highest_grade_sport_sent_clean_on_lead" id="form_highest_grade_sport_sent_clean_on_lead">
        <input type="hidden" name="highest_grade_tr_sent_clean" id="form_highest_grade_tr_sent_clean">
        <input type="hidden" name="highest_grade_trad_sent_clean_on_lead" id="form_highest_grade_trad_sent_clean_on_lead">
        <input type="hidden" name="highest_grade_boulder_sent_clean" id="form_highest_grade_boulder_sent_clean">
        <input type="hidden" name="onsight_grade_sport" id="form_onsight_grade_sport">
        <input type="hidden" name="onsight_grade_trad" id="form_onsight_grade_trad">
        <input type="hidden" name="flash_grade_boulder" id="form_flash_grade_boulder">
        
        <!-- Injury history and limitations -->
        <input type="hidden" name="current_injuries" id="form_current_injuries">
        <input type="hidden" name="injury_history" id="form_injury_history">
        <input type="hidden" name="physical_limitations" id="form_physical_limitations">
        
        <!-- Goals and preferences -->
        <input type="hidden" name="climbing_goals" id="form_climbing_goals">
        <input type="hidden" name="willing_to_train_indoors" id="form_willing_to_train_indoors">
        
        <!-- Recent activity -->
        <input type="hidden" name="sends_last_30_days" id="form_sends_last_30_days">
        
        <!-- Style preferences -->
        <input type="hidden" name="favorite_angle" id="form_favorite_angle">
        <input type="hidden" name="strongest_angle" id="form_strongest_angle">
        <input type="hidden" name="weakest_angle" id="form_weakest_angle">
        <input type="hidden" name="favorite_hold_types" id="form_favorite_hold_types">
        <input type="hidden" name="strongest_hold_types" id="form_strongest_hold_types">
        <input type="hidden" name="weakest_hold_types" id="form_weakest_hold_types">
        <input type="hidden" name="favorite_energy_type" id="form_favorite_energy_type">
        <input type="hidden" name="strongest_energy_type" id="form_strongest_energy_type">
        <input type="hidden" name="weakest_energy_type" id="form_weakest_energy_type">
        
        <!-- Lifestyle -->
        <input type="hidden" name="sleep_score" id="form_sleep_score">
        <input type="hidden" name="nutrition_score" id="form_nutrition_score">
        
        <!-- Additional notes -->
        <input type="hidden" name="additional_notes" id="form_additional_notes">
        
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      </form>

      <!-- Favorite Routes Section -->
      <section class="summary-section">
        <h3>Favorite Routes</h3>
        <div class="summary-grid">
          <div class="metric-item">
            <ul class="routes-list" id="favoriteRoutes"></ul>
          </div>
        </div>
      </section>

      <script>
        // Function to safely get nested values and update UI
        function getValue(obj, path, defaultValue = 'Not specified') {
          const value = path.split('.').reduce((acc, part) => acc && acc[part], obj) || defaultValue;
          return value;
        }

        // Function to update element and set background
        function updateElement(elementId, value) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const parentCard = element.closest('.metric-item');
          element.textContent = value;

          if (value === 'Not specified') {
            parentCard.classList.add('unspecified');
          } else {
            parentCard.classList.remove('unspecified');
          }
        }

        // Populate core progression metrics
        updateElement('yearsClimbing', getValue(climberSummary, 'years_climbing_outside') ? getValue(climberSummary, 'years_climbing_outside') + ' years' : 'Not specified');
        updateElement('totalClimbs', getValue(climberSummary, 'total_climbs'));
        updateElement('favoriteDiscipline', getValue(climberSummary, 'favorite_discipline'));
        updateElement('preferredCrag', getValue(climberSummary, 'preferred_crag_last_year'));

        // Populate performance metrics
        updateElement('highestSportLead', getValue(climberSummary, 'highest_grade_sport_sent_clean_on_lead'));
        updateElement('highestTradLead', getValue(climberSummary, 'highest_grade_trad_sent_clean_on_lead'));
        updateElement('highestBoulder', getValue(climberSummary, 'highest_grade_boulder_sent_clean'));
        updateElement('sportOnsight', getValue(climberSummary, 'onsight_grade_sport'));
        updateElement('tradOnsight', getValue(climberSummary, 'onsight_grade_trad'));
        updateElement('boulderFlash', getValue(climberSummary, 'flash_grade_boulder'));

        // Populate style preferences
        updateElement('favoriteAngle', getValue(climberSummary, 'favorite_angle'));
        updateElement('strongestAngle', getValue(climberSummary, 'strongest_angle'));
        updateElement('weakestAngle', getValue(climberSummary, 'weakest_angle'));
        updateElement('favoriteHoldTypes', getValue(climberSummary, 'favorite_hold_types'));
        updateElement('strongestHoldTypes', getValue(climberSummary, 'strongest_hold_types'));
        updateElement('weakestHoldTypes', getValue(climberSummary, 'weakest_hold_types'));
        updateElement('favoriteEnergyType', getValue(climberSummary, 'favorite_energy_type'));
        updateElement('strongestEnergyType', getValue(climberSummary, 'strongest_energy_type'));
        updateElement('weakestEnergyType', getValue(climberSummary, 'weakest_energy_type'));

        // Populate recent activity
        updateElement('recentSends', getValue(climberSummary, 'sends_last_30_days'));

        // Populate current projects
        const projectsList = document.getElementById('currentProjects');
        const projects = climberSummary.current_projects || [];
        if (projects.length === 0) {
          projectsList.closest('.metric-item').classList.add('unspecified');
          projectsList.innerHTML = '<li>No current projects</li>';
        } else {
          projectsList.innerHTML = projects.map(project => `
              <li>${project.name} (${project.grade}) - ${project.attempts} attempts</li>
            `).join('');
        }

        // Populate training context
        updateElement('trainingFrequency', getValue(climberSummary, 'training_frequency'));
        updateElement('sessionLength', getValue(climberSummary, 'typical_session_length'));

        const equipmentElement = document.getElementById('equipment');
        const hasHangboard = climberSummary.has_hangboard;
        const hasHomeWall = climberSummary.has_home_wall;
        if (hasHangboard === null && hasHomeWall === null) {
          equipmentElement.closest('.metric-item').classList.add('unspecified');
          equipmentElement.textContent = 'Not specified';
        } else {
          equipmentElement.innerHTML = `
              Hangboard: ${hasHangboard ? 'Yes' : 'No'}<br>
              Home Wall: ${hasHomeWall ? 'Yes' : 'No'}
            `;
        }

        updateElement('indoorTraining', climberSummary.willing_to_train_indoors === null ? 'Not specified' :
          climberSummary.willing_to_train_indoors ? 'Willing' : 'Not willing');

        // Populate favorite routes
        const routesList = document.getElementById('favoriteRoutes');
        const routes = climberSummary.recent_favorite_routes || [];
        if (routes.length === 0) {
          routesList.closest('.metric-item').classList.add('unspecified');
          routesList.innerHTML = '<li>No favorite routes</li>';
        } else {
          routesList.innerHTML = routes.map(route => `
              <li>
                <strong>${route.name}</strong> (${route.grade})<br>
                <small>${route.location} - ${route.discipline}</small>
                ${route.notes ? `<br><em>${route.notes}</em>` : ''}
              </li>
            `).join('');
        }
      </script>

    </div>
  </main>

  <footer>
    <nav class="footer-nav">
      <a href="{{ url_for('userviz', userId=userId) }}" class="footer-link">
        <i class="fas fa-chart-line"></i> Dashboard
      </a>
      <a href="{{ url_for('terms_and_privacy') }}" class="footer-link">
        <i class="fas fa-shield-alt"></i> Terms & Privacy
      </a>
      <a href="mailto:climbing.analytics@gmail.com" class="footer-link">
        <i class="fas fa-envelope"></i> Feedback
      </a>
    </nav>
  </footer>

  <script>
    // Form handling functions
    function toggleEdit(element, fieldType) {
      const wasEditing = element.classList.contains('editing');
      // Close any other open forms
      document.querySelectorAll('.metric-item.editing').forEach(item => {
        if (item !== element) {
          item.classList.remove('editing');
          item.querySelector('.edit-form').classList.remove('active');
        }
      });

      if (!wasEditing) {
        element.classList.add('editing');
        const form = element.querySelector('.edit-form');
        form.classList.add('active');

        // Pre-fill the form with existing values
        const formElements = form.querySelectorAll('input, select, textarea');
        formElements.forEach(input => {
          const fieldName = input.getAttribute('onchange').match(/updateFormValue\('(.+?)',/)[1];
          const value = climberSummary[fieldName];
          if (input.type === 'checkbox') {
            input.checked = value === true;
          } else {
            input.value = value || '';
          }
        });
      }
    }

    function updateFormValue(field, value) {
      document.getElementById(`form_${field}`).value = value;
      checkFormCompletion();
    }

    function checkFormCompletion() {
      const requiredFields = [
        'training_frequency',
        'typical_session_length',
        'climbing_goals',
        'willing_to_train_indoors'
      ];

      const isComplete = requiredFields.every(field =>
        document.getElementById(`form_${field}`).value !== ''
      );

      document.getElementById('submitFormBtn').disabled = !isComplete;
    }

    async function submitForm() {
      const formData = new FormData(document.getElementById('climberDataForm'));
      try {
        const response = await fetch(`/sage-chat/onboard?userId=${climberSummary.userId}`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          credentials: 'same-origin',
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          if (data.reset_chat) {
            window.location.reload();
          }
        } else {
          const errorData = await response.json();
          alert(errorData.error || 'Failed to update profile. Please try again.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating your profile.');
      }
    }

    // Initialize form values from climber summary
    function initializeForm() {
      const fields = [
        // Training context
        'training_frequency',
        'typical_session_length',
        'has_hangboard',
        'has_home_wall',
        'willing_to_train_indoors',

        // Health and injuries
        'current_injuries',
        'injury_history',
        'physical_limitations',

        // Goals and preferences
        'climbing_goals',
        'preferred_climbing_days',

        // Style preferences
        'favorite_angle',
        'strongest_angle',
        'weakest_angle',
        'favorite_hold_types',
        'strongest_hold_types',
        'weakest_hold_types',
        'favorite_energy_type',
        'strongest_energy_type',
        'weakest_energy_type'
      ];

      fields.forEach(field => {
        const value = climberSummary[field];
        if (value !== undefined && value !== null) {
          document.getElementById(`form_${field}`).value = value;
        }
      });

      checkFormCompletion();
    }

    // Call initialization when page loads
    document.addEventListener('DOMContentLoaded', initializeForm);
  </script>
</body>

</html>