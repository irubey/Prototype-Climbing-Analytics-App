<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-QLKC35PVJB"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-QLKC35PVJB");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Climbing Analytics</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />
    <!-- Preload loading screen images -->
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading1.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading2.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading3.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading4.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading5.jpg') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/landingPage.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/loadingScreen.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <div class="content-wrapper">
        <div class="main-content">
          <h1>Your Climbing Data Visualized</h1>
          <div class="input-container">
            <form
              action="/"
              method="POST"
              id="profileForm"
              onsubmit="return handleSubmit(event)"
            >
              <input
                type="text"
                name="first_input"
                placeholder="Paste your Mountain Project Profile URL Here"
                aria-label="Mountain Project Profile URL"
                id="profileInput"
              />
              <div class="error-message" id="errorMessage"></div>
              <div class="button-group">
                <button type="submit" class="primary-button" id="submitButton">
                  <span class="button-text">Analyze My Climbing</span>
                  <span class="loading-spinner"></span>
                </button>
                <button
                  type="button"
                  class="secondary-button"
                  id="demoButton"
                  onclick="tryDemo()"
                >
                  <span class="button-text">Try Demo</span>
                  <span class="loading-spinner"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <footer>
        <nav>
          <ul>
            <li><a href="mailto:climbing.analytics@gmail.com">Contact</a></li>
            <li>
              <a href="{{ url_for('terms_and_privacy') }}">Terms of Service</a>
            </li>
            <li>
              <a href="{{ url_for('terms_and_privacy') }}">Privacy Policy</a>
            </li>
          </ul>
        </nav>
      </footer>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: none">
      <div class="loading-overlay"></div>
      <div class="loading-content">
        <div class="loading-header">
          <h2>Analyzing Your Climbing Journey</h2>
          <div class="loading-icon">
            <div class="spinner"></div>
          </div>
        </div>

        <div class="loading-stages">
          <div class="stage" id="stage1">
            <div class="stage-dot"></div>
            <span>Fetching your climbing data</span>
          </div>
          <div class="stage" id="stage2">
            <div class="stage-dot"></div>
            <span>Processing routes and grades</span>
          </div>
          <div class="stage" id="stage3">
            <div class="stage-dot"></div>
            <span>Building performance metrics</span>
          </div>
          <div class="stage" id="stage4">
            <div class="stage-dot"></div>
            <span>Preparing visualizations</span>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <p class="loading-status">This may take a few moments</p>
        </div>
      </div>
    </div>

    <script>
      let isLoading = false;
      let currentStage = 0;
      const stages = ["stage1", "stage2", "stage3", "stage4"];
      const stageDelay = 2000; // 2 seconds per stage

      function setLoading(loading) {
        isLoading = loading;
        document
          .getElementById("submitButton")
          .classList.toggle("loading", loading);
        document
          .getElementById("demoButton")
          .classList.toggle("loading", loading);
        document.getElementById("profileInput").disabled = loading;
      }

      function updateLoadingStages() {
        if (currentStage < stages.length) {
          document.getElementById(stages[currentStage]).classList.add("active");
          currentStage++;
        }
      }

      function showLoadingScreen() {
        document.getElementById("loadingScreen").style.display = "flex";
        currentStage = 0;
        stages.forEach((stage) => {
          document.getElementById(stage).classList.remove("active");
        });
        document.querySelector(".progress-fill").style.width = "100%";
        updateLoadingStages();
      }

      function hideLoadingScreen() {
        document.getElementById("loadingScreen").style.display = "none";
        document.querySelector(".progress-fill").style.width = "0";
        currentStage = 0;
        stages.forEach((stage) => {
          document.getElementById(stage).classList.remove("active");
        });
      }

      async function submitForm(formData) {
        try {
          showLoadingScreen();

          // Log form data for debugging
          for (let pair of formData.entries()) {
          }

          // Stage 1: Fetching data
          updateLoadingStages();

          const response = await fetch("/", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(
              data.error || "An error occurred. Please try again."
            );
          }

          // Stage 2: Processing routes
          updateLoadingStages();

          // Wait a moment to show processing
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Stage 3: Building metrics
          updateLoadingStages();

          // Wait a moment to show processing
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Stage 4: Preparing visualizations
          updateLoadingStages();

          // Wait a moment before redirect
          await new Promise((resolve) => setTimeout(resolve, 500));

          // If successful, the response will be a redirect
          window.location.href = response.url;
        } catch (error) {
          hideLoadingScreen();
          setLoading(false);
          showError(error.message);
        }
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";
        document.getElementById("profileInput").classList.add("error");
      }

      function clearError() {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = "";
        errorElement.style.display = "none";
        document.getElementById("profileInput").classList.remove("error");
      }

      async function handleSubmit(event) {
        event.preventDefault();
        if (isLoading) return false;

        const input = document.getElementById("profileInput");
        const value = input.value.trim();

        clearError();

        if (!value) {
          showError("Please enter a Mountain Project profile URL");
          return false;
        }

        if (!value.includes("mountainproject.com/user/")) {
          showError(
            "Please enter valid URL: https://www.mountainproject.com/user/#########/your-username"
          );
          return false;
        }

        setLoading(true);
        const formData = new FormData();
        formData.append("first_input", value);
        await submitForm(formData);

        return false;
      }

      async function tryDemo() {
        if (isLoading) return;

        document.getElementById("profileInput").value =
          "https://www.mountainproject.com/user/200169262/isaac-rubey";
        const form = document.getElementById("profileForm");
        const formData = new FormData(form);

        setLoading(true);
        await submitForm(formData);
      }

      // Remove error state when user starts typing
      document
        .getElementById("profileInput")
        .addEventListener("input", function () {
          clearError();
        });
    </script>
    <script src="{{ url_for('static', filename='js/loadingScreen.js') }}"></script>
  </body>
</html>
