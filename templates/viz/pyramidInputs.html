{% extends "viz/base_viz.html" %}

{% block title %}Performance Pyramid{% endblock %}

{% block page_title %}Route Information Input{% endblock %}

{% block head_scripts %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pyramidInputs.css') }}" />
{% endblock %}

{% block content %}
<div class="container">
  {% block data_vars %}
  <script>
    // Initialize data with proper JSON parsing using tojson filter
    const pyramidData = {
      sport: {{ sport_pyramid|tojson|safe }},
      trad: {{ trad_pyramid|tojson|safe }},
      boulder: {{ boulder_pyramid|tojson|safe }}
    };
    const gradeData = {
      routes: {{ routes_grade_list|tojson|safe }},
      boulders: {{ boulders_grade_list|tojson|safe }}
    };

    // Debug logs
    console.log('Pyramid Data:', {
      sport: {
        type: typeof pyramidData.sport,
        isArray: Array.isArray(pyramidData.sport),
        length: pyramidData.sport?.length,
        sample: pyramidData.sport?.[0]
      },
      trad: {
        type: typeof pyramidData.trad,
        isArray: Array.isArray(pyramidData.trad),
        length: pyramidData.trad?.length,
        sample: pyramidData.trad?.[0]
      },
      boulder: {
        type: typeof pyramidData.boulder,
        isArray: Array.isArray(pyramidData.boulder),
        length: pyramidData.boulder?.length,
        sample: pyramidData.boulder?.[0]
      }
    });
  </script>
  {% endblock %}

  <!-- Add flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %}
  <div class="flash-messages">
    {% for category, message in messages %}
    <div class="flash-message {{ category }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %} {% endwith %}

  <section class="dashboard-section">
    <div class="info-box">
      <p><strong>Instructions:</strong></p>
      <ul>
        <li>
          Enter route information here to get more accurate performance
          visualizations
        </li>
        <li>Submit form at bottom of page</li>
        <li>
          Route names are linked to their respective pages if you need to
          remember the particulars of a route
        </li>
        <li>
          Attempts Before Clean Send defaults to total logged pitches before
          a clean ascent
        </li>
      </ul>
    </div>

    <div class="discipline-selector">
      <button type="button" class="discipline-btn active" data-discipline="sport">
        Sport
      </button>
      <button type="button" class="discipline-btn" data-discipline="trad">
        Trad
      </button>
      <button type="button" class="discipline-btn" data-discipline="boulder">
        Boulder
      </button>
    </div>

    <form id="pyramid-form" method="POST" action="{{ url_for('main.pyramid_input') }}" onsubmit="return false;">
      <section class="discipline-section active" id="sport-section">
        <h2>Sport Performance</h2>
        <div class="chart-container">
          <table class="performance-table">
            <thead>
              <tr>
                <th class="route-info-column">Route Information</th>
                <th class="attempts-info-column">Attempts Info</th>
                <th class="characteristics-column">Crux Characteristics</th>
                <th class="additional-info-column">Additional Details</th>
                <th class="actions-column"></th>
              </tr>
            </thead>
            <tbody>
              {% for row in sport_pyramid %}
              <tr data-tick-id="{{ row.tick_id }}" data-discipline="sport">
                <td class="route-info-column">
                  <span class="column-label">Route Name</span>
                  <div class="route-name">
                    {% if row.route_url %}
                    <a href="{{ row.route_url }}" target="_blank" class="route-link">{{ row.route_name }}</a>
                    {% else %}
                    <input type="text" name="sport_route_name_{{ row.tick_id }}" value="{{ row.route_name }}" required>
                    {% endif %}
                  </div>
                  <span class="column-label">Grade</span>
                  <select class="grade-select" name="sport_route_grade_{{ row.tick_id }}" required>
                    {% for grade in routes_grade_list %}
                    <option value="{{ grade }}" {% if grade==row.route_grade %}selected{% endif %}>{{ grade }}</option>
                    {% endfor %}
                  </select>
                  <span class="column-label">Send Date</span>
                  <input type="date" name="sport_send_date_{{ row.tick_id }}" 
                         value="{{ row.send_date.strftime('%Y-%m-%d') }}" 
                         class="date-input" required>
                  <span class="column-label">Location</span>
                  <input type="text" name="sport_location_{{ row.tick_id }}" 
                         value="{{ row.location }}" 
                         class="location-input" 
                         placeholder="Enter location">
                </td>
                <td class="attempts-info-column">
                  <div class="attempts-info-group">
                    <span class="column-label">Attempts to Send</span>
                    <div class="attempts-input-group">
                      <button type="button" class="attempts-btn minus-btn">
                        <i class="fas fa-minus"></i>
                      </button>
                      <input type="number" name="sport_num_attempts_{{ row.tick_id }}" 
                             value="{{ row.num_attempts }}" 
                             class="attempts-input" min="1">
                      <button type="button" class="attempts-btn plus-btn">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                    <div class="attempts-visual-indicator">
                      {% for i in range(row.num_attempts - 1) %}
                      <span class="attempt-icon failure">
                        <i class="fas fa-times"></i>
                      </span>
                      {% endfor %}
                      <span class="attempt-icon success">
                        <i class="fas fa-check"></i>
                      </span>
                    </div>
                    <span class="column-label">Days Projected</span>
                    <input type="number" name="sport_days_tried_{{ row.tick_id }}" 
                           value="{{ row.days_tried }}" 
                           class="days-input" 
                           min="1" 
                           placeholder="Number of days">
                  </div>
                </td>
                <td class="characteristics-column">
                  <div class="characteristics-group">
                    <span class="column-label">
                      <i class="fas fa-bolt"></i>Crux Energy System
                    </span>
                    <div class="table-radio-group">
                      {% for energy_type in ['Power', 'Power Endurance', 'Endurance', 'Technique'] %}
                      <label>
                        <input type="radio" name="sport_crux_energy_{{ row.tick_id }}" 
                               value="{{ energy_type }}" 
                               {% if row.crux_energy and row.crux_energy.value==energy_type %}checked{% endif %}>
                        <span>{{ energy_type }}</span>
                      </label>
                      {% endfor %}
                    </div>
                    <span class="column-label">
                      <i class="fas fa-mountain"></i>Crux Angle
                    </span>
                    <div class="table-radio-group">
                      {% for angle in ['Slab', 'Vertical', 'Overhang', 'Roof'] %}
                      <label>
                        <input type="radio" name="sport_crux_angle_{{ row.tick_id }}" 
                               value="{{ angle }}" 
                               {% if row.crux_angle and row.crux_angle.value==angle %}checked{% endif %}>
                        <span>{{ angle }}</span>
                      </label>
                      {% endfor %}
                    </div>
                  </div>
                </td>
                <td class="additional-info-column">
                  <span class="column-label">Route Length (ft)</span>
                  <input type="number" name="sport_length_{{ row.tick_id }}" 
                         value="{{ row.length }}" 
                         class="length-input" 
                         min="0" 
                         placeholder="Enter length">
                  <span class="column-label">Description of Experience</span>
                  <textarea name="sport_description_{{ row.tick_id }}" 
                          class="description-input" 
                          placeholder="Add any additional notes">{{ row.description if row.description and row.description != 'None' else '' }}</textarea>
                </td>
                <td class="actions-column">
                  <button type="button" class="remove-btn" aria-label="Remove route">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="add-route-row">
            <button type="button" class="add-route-btn">
              <i class="fas fa-plus"></i> Add Route
            </button>
          </div>
        </div>
      </section>

      <section class="discipline-section" id="trad-section">
        <h2>Trad Performance</h2>
        <div class="chart-container">
          <table class="performance-table">
            <thead>
              <tr>
                <th class="route-info-column">Route Information</th>
                <th class="attempts-info-column">Attempts Info</th>
                <th class="characteristics-column">Crux Characteristics</th>
                <th class="style-column">Crux Angle</th>
                <th class="actions-column"></th>
              </tr>
            </thead>
            <tbody>
              {% for row in trad_pyramid %}
              <tr data-tick-id="{{ row.tick_id }}" data-discipline="trad">
                <td class="route-info-column">
                  <div class="route-name">
                    <a href="{{ row.route_url }}" target="_blank" class="route-link">{{ row.route_name }}</a>
                  </div>
                  <select class="grade-select" name="trad_route_grade_{{ row.tick_id }}" required>
                    {% for grade in routes_grade_list %}
                    <option value="{{ grade }}" {% if grade==row.route_grade %}selected{% endif %}>{{ grade }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td class="attempts-info-column">
                  <div class="attempts-info-group">
                    <div class="attempts-input-group">
                      <button type="button" class="attempts-btn minus-btn" aria-label="Decrease attempts">
                        <i class="fas fa-minus"></i>
                      </button>
                      <input type="number" name="trad_num_attempts_{{ row.tick_id }}" 
                             value="{{ row.num_attempts }}" 
                             class="attempts-input" min="1" />
                      <button type="button" class="attempts-btn plus-btn" aria-label="Increase attempts">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                    <div class="attempts-visual-indicator">
                      {% for i in range(row.num_attempts - 1) %}
                      <span class="attempt-icon failure">
                        <i class="fas fa-times"></i>
                      </span>
                      {% endfor %}
                      <span class="attempt-icon success">
                        <i class="fas fa-check"></i>
                      </span>
                    </div>
                    <span class="column-label">Days Projected</span>
                    <input type="number" name="trad_days_tried_{{ row.tick_id }}" 
                           value="{{ row.days_tried }}" 
                           class="days-input" 
                           min="1" 
                           placeholder="Number of days">
                  </div>
                </td>
                <td class="characteristics-column">
                  <div class="characteristics-group">
                    <div class="table-radio-group">
                      <label>
                        <input type="radio" name="trad_route_characteristic_{{ row.tick_id }}" 
                               value="Power" 
                               {% if row.route_characteristic=='Power' %}checked{% endif %}>
                        <span>Power</span>
                      </label>
                      <label>
                        <input type="radio" name="trad_route_characteristic_{{ row.tick_id }}" 
                               value="Power Endurance" 
                               {% if row.route_characteristic=='Power Endurance' %}checked{% endif %}>
                        <span>Power Endurance</span>
                      </label>
                      <label>
                        <input type="radio" name="trad_route_characteristic_{{ row.tick_id }}" 
                               value="Endurance" 
                               {% if row.route_characteristic=='Endurance' %}checked{% endif %}>
                        <span>Endurance</span>
                      </label>
                    </div>
                  </div>
                </td>
                <td class="style-column">
                  <div class="table-radio-group">
                    <label>
                      <input type="radio" name="trad_route_style_{{ row.tick_id }}" 
                             value="Slab" 
                             {% if row.route_style=='Slab' %}checked{% endif %}>
                      <span>Slab</span>
                    </label>
                    <label>
                      <input type="radio" name="trad_route_style_{{ row.tick_id }}" 
                             value="Vertical" 
                             {% if row.route_style=='Vertical' %}checked{% endif %}>
                      <span>Vertical</span>
                    </label>
                    <label>
                      <input type="radio" name="trad_route_style_{{ row.tick_id }}" 
                             value="Overhang" 
                             {% if row.route_style=='Overhang' %}checked{% endif %}>
                      <span>Overhang</span>
                    </label>
                    <label>
                      <input type="radio" name="trad_route_style_{{ row.tick_id }}" 
                             value="Roof" 
                             {% if row.route_style=='Roof' %}checked{% endif %}>
                      <span>Roof</span>
                    </label>
                  </div>
                </td>
                <td class="actions-column">
                  <button type="button" class="remove-btn" aria-label="Remove route">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="add-route-row">
            <button type="button" class="add-route-btn">
              <i class="fas fa-plus"></i>
              Add Route
            </button>
          </div>
        </div>
      </section>

      <section class="discipline-section" id="boulder-section">
        <h2>Boulder Performance</h2>
        <div class="chart-container">
          <table class="performance-table">
            <thead>
              <tr>
                <th class="route-info-column">Route Information</th>
                <th class="attempts-info-column">Attempts Info</th>
                <th class="characteristics-column">Crux Characteristics</th>
                <th class="style-column">Crux Angle</th>
                <th class="actions-column"></th>
              </tr>
            </thead>
            <tbody>
              {% for row in boulder_pyramid %}
              <tr data-tick-id="{{ row.tick_id }}" data-discipline="boulder">
                <td class="route-info-column">
                  <div class="route-name">
                    <a href="{{ row.route_url }}" target="_blank" class="route-link">{{ row.route_name }}</a>
                  </div>
                  <select class="grade-select" name="boulder_route_grade_{{ row.tick_id }}" required>
                    {% for grade in boulders_grade_list %}
                    <option value="{{ grade }}" {% if grade==row.route_grade %}selected{% endif %}>{{ grade }}</option>
                    {% endfor %}
                  </select>
                </td>
                <td class="attempts-info-column">
                  <div class="attempts-info-group">
                    <div class="attempts-input-group">
                      <button type="button" class="attempts-btn minus-btn" aria-label="Decrease attempts">
                        <i class="fas fa-minus"></i>
                      </button>
                      <input type="number" name="boulder_num_attempts_{{ row.tick_id }}" 
                             value="{{ row.num_attempts }}" 
                             class="attempts-input" min="1" />
                      <button type="button" class="attempts-btn plus-btn" aria-label="Increase attempts">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                    <div class="attempts-visual-indicator">
                      {% for i in range(row.num_attempts - 1) %}
                      <span class="attempt-icon failure">
                        <i class="fas fa-times"></i>
                      </span>
                      {% endfor %}
                      <span class="attempt-icon success">
                        <i class="fas fa-check"></i>
                      </span>
                    </div>
                    <span class="column-label">Days Projected</span>
                    <input type="number" name="boulder_days_tried_{{ row.tick_id }}" 
                           value="{{ row.days_tried }}" 
                           class="days-input" 
                           min="1" 
                           placeholder="Number of days">
                  </div>
                </td>
                <td class="characteristics-column">
                  <div class="characteristics-group">
                    <div class="table-radio-group">
                      <label>
                        <input type="radio" name="boulder_route_characteristic_{{ row.tick_id }}" 
                               value="Power" 
                               {% if row.route_characteristic=='Power' %}checked{% endif %}>
                        <span>Power</span>
                      </label>
                      <label>
                        <input type="radio" name="boulder_route_characteristic_{{ row.tick_id }}" 
                               value="Power Endurance" 
                               {% if row.route_characteristic=='Power Endurance' %}checked{% endif %}>
                        <span>Power Endurance</span>
                      </label>
                      <label>
                        <input type="radio" name="boulder_route_characteristic_{{ row.tick_id }}" 
                               value="Endurance" 
                               {% if row.route_characteristic=='Endurance' %}checked{% endif %}>
                        <span>Endurance</span>
                      </label>
                    </div>
                  </div>
                </td>
                <td class="style-column">
                  <div class="table-radio-group">
                    <label>
                      <input type="radio" name="boulder_route_style_{{ row.tick_id }}" 
                             value="Slab" 
                             {% if row.route_style=='Slab' %}checked{% endif %}>
                      <span>Slab</span>
                    </label>
                    <label>
                      <input type="radio" name="boulder_route_style_{{ row.tick_id }}" 
                             value="Vertical" 
                             {% if row.route_style=='Vertical' %}checked{% endif %}>
                      <span>Vertical</span>
                    </label>
                    <label>
                      <input type="radio" name="boulder_route_style_{{ row.tick_id }}" 
                             value="Overhang" 
                             {% if row.route_style=='Overhang' %}checked{% endif %}>
                      <span>Overhang</span>
                    </label>
                    <label>
                      <input type="radio" name="boulder_route_style_{{ row.tick_id }}" 
                             value="Roof" 
                             {% if row.route_style=='Roof' %}checked{% endif %}>
                      <span>Roof</span>
                    </label>
                  </div>
                </td>
                <td class="actions-column">
                  <button type="button" class="remove-btn" aria-label="Remove route">
                    <i class="fas fa-times"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="add-route-row">
            <button type="button" class="add-route-btn">
              <i class="fas fa-plus"></i>
              Add Route
            </button>
          </div>
        </div>
      </section>

      <div class="text-center">
        <button type="button" id="submit-button" class="submit-btn" onclick="submitForm(event)">
          Submit Changes
        </button>
        <div id="loading-spinner" style="display: none;">
          <i class="fas fa-spinner fa-spin"></i> Saving changes...
        </div>
      </div>

      <div id="toast" class="toast" style="display: none;"></div>
    </form>
  </section>
</div>

<footer>
  <nav class="footer-nav">
    <a href="{{ url_for('main.userviz') }}" class="footer-link">
      <i class="fas fa-chart-line"></i> Dashboard
    </a>
    <a href="{{ url_for('main.terms_and_privacy') }}" class="footer-link">
      <i class="fas fa-shield-alt"></i> Terms & Privacy
    </a>
    <a href="mailto:climbing.analytics@gmail.com" class="footer-link">
      <i class="fas fa-envelope"></i> Feedback
    </a>
  </nav>
</footer>

{% endblock %}

{% block scripts %}
<script>
  let hasUnsavedChanges = false;
  const submitData = {
    sport: { updated: new Map(), removed: new Set() },
    trad: { updated: new Map(), removed: new Set() },
    boulder: { updated: new Map(), removed: new Set() }
  };

  function updateNavigationState() {
    const navLinks = document.querySelectorAll('a:not([target]):not([href*="mailto"])');
    navLinks.forEach(link => {
      if (hasUnsavedChanges) {
        link.addEventListener('click', handleNavigation);
        link.style.opacity = '0.5';
        link.title = 'Please save your changes before leaving';
      } else {
        link.removeEventListener('click', handleNavigation);
        link.style.opacity = '';
        link.title = '';
      }
    });
  }

  function handleNavigation(e) {
    const link = e.target.closest('a');
    if (!link || link.hasAttribute('target') || link.href.includes('mailto:')) {
      return;
    }

    if (hasUnsavedChanges) {
      e.preventDefault();
      if (confirm('You have unsaved changes. If you leave, all changes will be lost. Submit changes at bottom of page.')) {
        document.querySelector('form').submit();
      } else if (confirm('Are you sure you want to leave? All unsaved changes will be lost.')) {
        hasUnsavedChanges = false;
        updateNavigationState();
        window.location.href = link.href;
      }
    }
  }

  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'block';
    setTimeout(() => {
      toast.style.display = 'none';
    }, 3000);
  }

  function validateForm() {
    let isValid = true;
    const requiredFields = ['route_name', 'route_grade', 'send_date'];
    
    ['sport', 'trad', 'boulder'].forEach(discipline => {
      const rows = document.querySelectorAll(`#${discipline}-section tbody tr[data-tick-id]`);
      rows.forEach(row => {
        const tickId = row.dataset.tickId;
        
        // Validate required fields
        requiredFields.forEach(field => {
          const input = row.querySelector(`[name="${discipline}_${field}_${tickId}"]`);
          if (input && !input.value) {
            input.classList.add('error');
            isValid = false;
          }
        });
      });
    });
    
    if (!isValid) {
      showToast('Please fill in all required fields', 'error');
    }
    
    return isValid;
  }

  function collectFormData() {
    const formData = {
      sport: { updated: [], removed: Array.from(submitData.sport.removed) },
      trad: { updated: [], removed: Array.from(submitData.trad.removed) },
      boulder: { updated: [], removed: Array.from(submitData.boulder.removed) }
    };
    
    ['sport', 'trad', 'boulder'].forEach(discipline => {
      const section = document.getElementById(`${discipline}-section`);
      const rows = section.querySelectorAll('tr[data-tick-id]');
      
      rows.forEach(row => {
        const tickId = row.dataset.tickId;
        const routeName = row.querySelector(`[name="${discipline}_route_name_${tickId}"]`)?.value;
        const routeGrade = row.querySelector(`[name="${discipline}_route_grade_${tickId}"]`)?.value;
        const sendDate = row.querySelector(`[name="${discipline}_send_date_${tickId}"]`)?.value;
        const location = row.querySelector(`[name="${discipline}_location_${tickId}"]`)?.value;
        const numAttempts = parseInt(row.querySelector(`[name="${discipline}_num_attempts_${tickId}"]`)?.value);
        const daysTried = parseInt(row.querySelector(`[name="${discipline}_days_tried_${tickId}"]`)?.value);
        const cruxEnergy = row.querySelector(`[name="${discipline}_crux_energy_${tickId}"]:checked`)?.value;
        const cruxAngle = row.querySelector(`[name="${discipline}_crux_angle_${tickId}"]:checked`)?.value;
        const length = parseInt(row.querySelector(`[name="${discipline}_length_${tickId}"]`)?.value) || 0;
        const description = row.querySelector(`[name="${discipline}_description_${tickId}"]`)?.value;
        
        // Only include in updated if it's a new entry (starts with temp_) or has tracked changes
        if (tickId.startsWith('temp_') || submitData[discipline].updated.has(tickId)) {
          formData[discipline].updated.push({
            tick_id: tickId,
            route_name: routeName,
            route_grade: routeGrade,
            send_date: sendDate,
            location: location,
            num_attempts: numAttempts,
            days_tried: daysTried,
            crux_energy: cruxEnergy,
            crux_angle: cruxAngle,
            length: length,
            description: description
          });
        }
      });
    });
    
    return formData;
  }

  async function submitForm(event) {
    if (event) {
      event.preventDefault();
    }
    
    if (!validateForm()) {
      return;
    }
    
    const formData = collectFormData();
    const submitButton = document.getElementById('submit-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    try {
      submitButton.disabled = true;
      loadingSpinner.style.display = 'inline-block';

      // First, create new UserTicks entries and get their IDs
      for (const discipline of ['sport', 'trad', 'boulder']) {
        // Filter new entries by checking if the tick_id starts with 'temp_'
        const newEntries = formData[discipline].updated.filter(entry => 
          entry && typeof entry === 'object' && entry.tick_id && entry.tick_id.startsWith('temp_')
        );
        const existingEntries = formData[discipline].updated.filter(entry => 
          entry && typeof entry === 'object' && entry.tick_id && !entry.tick_id.startsWith('temp_')
        );
        
        if (newEntries.length > 0) {
          console.log(`Creating ${newEntries.length} new entries for ${discipline}`);
          const createTicksResponse = await fetch('{{ url_for("main.create_ticks") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
              discipline: discipline,
              entries: newEntries
            })
          });
          
          if (!createTicksResponse.ok) {
            throw new Error(`Failed to create new ticks for ${discipline}`);
          }
          
          // Get the new tick IDs
          const newTickIds = await createTicksResponse.json();
          console.log(`Received new tick IDs:`, newTickIds);
          
          // Replace temporary IDs with real ones
          formData[discipline].updated = [
            ...existingEntries,
            ...newEntries.map((entry, index) => ({
              ...entry,
              tick_id: newTickIds[index].toString() // Ensure tick_id is a string
            }))
          ];
        }
      }
      
      console.log('Submitting final form data:', formData);
      
      // Now submit the complete form with real tick IDs
      const response = await fetch('{{ url_for("main.pyramid_input") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        hasUnsavedChanges = false;
        updateNavigationState();
        showToast(result.message || 'Changes saved successfully', 'success');
        // Redirect to the performance pyramid page after a short delay
        setTimeout(() => {
          window.location.href = result.redirect_url;
        }, 1000);
      } else {
        showToast(result.message || 'Error saving changes', 'error');
      }
    } catch (error) {
      console.error('Error:', error);
      showToast('Error saving changes. Please try again.', 'error');
    } finally {
      submitButton.disabled = false;
      loadingSpinner.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // Initialize default active discipline
    const defaultDiscipline = 'sport';
    const defaultBtn = document.querySelector(`.discipline-btn[data-discipline="${defaultDiscipline}"]`);
    const defaultSection = document.getElementById(defaultDiscipline + '-section');
    if (defaultBtn && defaultSection) {
      defaultBtn.classList.add('active');
      defaultSection.classList.add('active');
    }

    // Add discipline toggle functionality
    const disciplineButtons = document.querySelectorAll('.discipline-btn');
    disciplineButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        // Remove active class from all buttons
        disciplineButtons.forEach(function (b) {
          b.classList.remove('active');
        });
        // Add active class to clicked button
        this.classList.add('active');

        // Hide all sections
        const sections = document.querySelectorAll('.discipline-section');
        sections.forEach(function (section) {
          section.classList.remove('active');
        });

        // Show selected section
        const discipline = this.getAttribute('data-discipline');
        const selectedSection = document.getElementById(discipline + '-section');
        if (selectedSection) {
          selectedSection.classList.add('active');
        }
      });
    });

    // Function to update attempts visual
    function updateAttemptsVisual(input) {
      const attemptsValue = parseInt(input.value) || 1;
      const visualContainer = input.closest('.attempts-info-group').querySelector('.attempts-visual-indicator');
      
      // Clear existing content
      visualContainer.innerHTML = '';
      
      // Create attempts icons container
      const iconsContainer = document.createElement('div');
      iconsContainer.className = 'attempts-icons';
      
      if (attemptsValue <= 6) {
        // Add individual X's for 5 or fewer failures
        for (let i = 0; i < attemptsValue - 1; i++) {
          iconsContainer.innerHTML += `
            <span class="attempt-icon failure">
              <i class="fas fa-times"></i>
            </span>
          `;
        }
      } else {
        // For more than 5 failures, show the number followed by an X
        iconsContainer.innerHTML += `
          <span class="attempt-icon failure">
            <span class="attempts-count">${attemptsValue - 1}</span>
            <i class="fas fa-times"></i>
          </span>
        `;
      }
      
      // Add the success icon (check) for the send
      iconsContainer.innerHTML += `
        <span class="attempt-icon success">
          <i class="fas fa-check"></i>
        </span>
      `;
      
      // Add send type label
      const sendTypeLabel = document.createElement('span');
      sendTypeLabel.className = 'send-type-label';
      sendTypeLabel.textContent = attemptsValue === 1 ? 'Onsight/Flash' : 'Redpoint';
      
      // Add both containers to the visual container
      visualContainer.appendChild(sendTypeLabel);
      visualContainer.appendChild(iconsContainer);
    }

    // Setup attempts controls
    function setupAttemptsControls(minusBtn, plusBtn, input) {
      function updateButtons() {
        const value = parseInt(input.value) || 1;
        minusBtn.disabled = value <= 1;
        updateAttemptsVisual(input);
      }

      function trackAttemptChange(input) {
        const row = input.closest('tr');
        if (row) {
          const tickId = row.dataset.tickId;
          const discipline = input.name.split('_')[0];
          if (tickId && discipline in submitData) {
            if (!submitData[discipline].updated.has(tickId)) {
              submitData[discipline].updated.set(tickId, {});
            }
            const value = parseInt(input.value) || 1;
            submitData[discipline].updated.get(tickId)['num_attempts'] = value;
            console.log(`Tracking num_attempts change for ${tickId} to ${value}`);
          }
        }
        updateAttemptsVisual(input);
      }

      input.addEventListener('input', () => {
        let value = parseInt(input.value) || 1;
        if (value < 1) value = 1;
        input.value = value;
        updateButtons();
        trackAttemptChange(input);
        hasUnsavedChanges = true;
        updateNavigationState();
      });

      minusBtn.addEventListener('click', () => {
        let value = parseInt(input.value) || 1;
        if (value > 1) {
          input.value = value - 1;
          updateButtons();
          trackAttemptChange(input);
          hasUnsavedChanges = true;
          updateNavigationState();
        }
      });

      plusBtn.addEventListener('click', () => {
        let value = parseInt(input.value) || 1;
        input.value = value + 1;
        updateButtons();
        trackAttemptChange(input);
        hasUnsavedChanges = true;
        updateNavigationState();
      });

      // Initialize the visual indicator
      updateButtons();
    }

    // Setup remove button handlers
    function setupRemoveButton(btn) {
      btn.addEventListener('click', function() {
        const row = this.closest('tr');
        const tickId = row.dataset.tickId;
        const discipline = row.dataset.discipline;
        
        // Add to removed set
        if (tickId && !tickId.startsWith('temp_')) {
          submitData[discipline].removed.add(tickId);
          // Remove from updated if it was there
          submitData[discipline].updated.delete(tickId);
        }
        
        row.remove();
        hasUnsavedChanges = true;
        updateNavigationState();
        console.log(`Removed route ${tickId} from ${discipline}`, submitData);
      });
    }

    // Setup row controls
    function setupRowControls(row) {
      // Attempts controls
      const attemptsInput = row.querySelector('.attempts-input');
      const minusBtn = row.querySelector('.minus-btn');
      const plusBtn = row.querySelector('.plus-btn');
      
      if (minusBtn && plusBtn && attemptsInput) {
        setupAttemptsControls(minusBtn, plusBtn, attemptsInput);
      }
      
      // Days tried input
      const daysInput = row.querySelector('.days-input');
      if (daysInput) {
        daysInput.addEventListener('change', () => {
          if (parseInt(daysInput.value) < 1) {
            daysInput.value = 1;
          }
          hasUnsavedChanges = true;
          updateNavigationState();
        });
      }
      
      // Length input
      const lengthInput = row.querySelector('.length-input');
      if (lengthInput) {
        lengthInput.addEventListener('change', () => {
          if (parseInt(lengthInput.value) < 0) {
            lengthInput.value = 0;
          }
          hasUnsavedChanges = true;
          updateNavigationState();
        });
      }
      
      // Description input
      const descriptionInput = row.querySelector('.description-input');
      if (descriptionInput) {
        descriptionInput.addEventListener('input', () => {
          hasUnsavedChanges = true;
          updateNavigationState();
        });
      }
      
      // Remove button - use setupRemoveButton instead of simple handler
      const removeBtn = row.querySelector('.remove-btn');
      if (removeBtn) {
        setupRemoveButton(removeBtn);
      }
      
      // Add change listeners to all inputs
      const inputs = row.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('change', () => {
          hasUnsavedChanges = true;
          updateNavigationState();
        });
      });
    }

    // Initialize controls for existing rows
    document.querySelectorAll('tr[data-tick-id]').forEach(row => {
      setupRowControls(row);
    });

    // Function to track field changes
    function trackFieldChange(input) {
        const row = input.closest('tr');
        if (!row) return;
        
        const tickId = row.dataset.tickId;
        const discipline = row.dataset.discipline;
        if (!tickId || !discipline || !(discipline in submitData)) return;
        
        const fieldName = input.dataset.field;
        const newValue = input.value.trim();
        const originalValue = input.dataset.originalValue;
        
        // Only track if value has changed from original
        if (newValue !== originalValue) {
            if (!submitData[discipline].updated.has(tickId)) {
                submitData[discipline].updated.set(tickId, {});
            }
            submitData[discipline].updated.get(tickId)[fieldName] = newValue;
            console.log(`Tracking ${fieldName} change for ${tickId} from ${originalValue} to ${newValue}`);
        } else {
            // If value is back to original, remove it from changes
            if (submitData[discipline].updated.has(tickId)) {
                const changes = submitData[discipline].updated.get(tickId);
                delete changes[fieldName];
                // If no changes left, remove the tick from updated
                if (Object.keys(changes).length === 0) {
                    submitData[discipline].updated.delete(tickId);
                }
            }
        }
        
        hasUnsavedChanges = true;
        updateNavigationState();
    }

    // Setup input tracking for a row
    function setupInputTracking(row) {
        const inputs = row.querySelectorAll('input[data-field], select[data-field], textarea[data-field]');
        inputs.forEach(input => {
            // Store original value
            input.dataset.originalValue = input.value.trim();
            
            // Add change listener
            input.addEventListener('change', () => trackFieldChange(input));
            if (input.tagName.toLowerCase() === 'textarea') {
                input.addEventListener('input', () => trackFieldChange(input));
            }
        });
    }

    // Keep only this single addNewRow function
    function addNewRow(discipline) {
        // Generate UUID v4 for temporary ID
        const newId = 'temp_' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
        const tbody = document.querySelector(`#${discipline}-section tbody`);
        
        const row = document.createElement('tr');
        row.dataset.tickId = newId;
        row.dataset.discipline = discipline;
        
        const gradeOptions = discipline === 'boulder' 
            ? gradeData.boulders.map(grade => `<option value="${grade}">${grade}</option>`).join('')
            : gradeData.routes.map(grade => `<option value="${grade}">${grade}</option>`).join('');
            
        const energyTypes = ['None', 'Power', 'Power Endurance', 'Endurance', 'Technique']
            .map(type => `
                <label>
                    <input type="radio" name="${discipline}_crux_energy_${newId}" value="${type === 'None' ? '' : type}" data-field="crux_energy">
                    <span>${type}</span>
                </label>
            `).join('');
            
        const angleTypes = ['None', 'Slab', 'Vertical', 'Overhang', 'Roof']
            .map(angle => `
                <label>
                    <input type="radio" name="${discipline}_route_style_${newId}" value="${angle === 'None' ? '' : angle}" data-field="route_style">
                    <span>${angle}</span>
                </label>
            `).join('');

        row.innerHTML = `
            <td class="route-info-column">
                <span class="column-label">Route Name</span>
                <div class="route-name">
                    <input type="text" name="${discipline}_route_name_${newId}" data-field="route_name" required placeholder="Enter route name">
                </div>
                <span class="column-label">Grade</span>
                <select class="grade-select" name="${discipline}_route_grade_${newId}" data-field="route_grade" required>
                    <option value="" disabled selected>Select Grade</option>
                    ${gradeOptions}
                </select>
                <span class="column-label">Send Date</span>
                <input type="date" name="${discipline}_send_date_${newId}" data-field="send_date" required>
                <span class="column-label">Location</span>
                <input type="text" name="${discipline}_location_${newId}" data-field="location" required placeholder="Enter location">
            </td>
            <td class="attempts-info-column">
                <div class="attempts-info-group">
                    <span class="column-label">Attempts to Send</span>
                    <div class="attempts-input-group">
                        <button type="button" class="attempts-btn minus-btn">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" name="${discipline}_num_attempts_${newId}" 
                               class="attempts-input" value="1" min="1" data-field="num_attempts">
                        <button type="button" class="attempts-btn plus-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="attempts-visual-indicator">
                        <span class="attempt-icon success">
                            <i class="fas fa-check"></i>
                        </span>
                    </div>
                    <span class="column-label">Days Projected</span>
                    <input type="number" name="${discipline}_days_tried_${newId}" 
                           class="days-input" value="1" min="1" data-field="days_tried" placeholder="Number of days">
                </div>
            </td>
            <td class="characteristics-column">
                <div class="characteristics-group">
                    <span class="column-label">Crux Energy System</span>
                    <div class="table-radio-group">
                        ${energyTypes}
                    </div>
                    <span class="column-label">Crux Angle</span>
                    <div class="table-radio-group">
                        ${angleTypes}
                    </div>
                </div>
            </td>
            <td class="additional-info-column">
                <span class="column-label">Route Length (ft)</span>
                <input type="number" name="${discipline}_length_${newId}" 
                       class="length-input" min="0" data-field="length" placeholder="Length">
                <span class="column-label">Description of Experience</span>
                <textarea name="${discipline}_description_${newId}" 
                          class="description-input" data-field="description" placeholder="Description"></textarea>
            </td>
            <td class="actions-column">
                <button type="button" class="remove-btn" aria-label="Remove route">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        setupInputTracking(row);
        setupRowControls(row);
        
        // Select the "None" options by default
        const noneEnergyRadio = row.querySelector(`input[name="${discipline}_crux_energy_${newId}"][value=""]`);
        const noneAngleRadio = row.querySelector(`input[name="${discipline}_route_style_${newId}"][value=""]`);
        if (noneEnergyRadio) noneEnergyRadio.checked = true;
        if (noneAngleRadio) noneAngleRadio.checked = true;
        
        hasUnsavedChanges = true;
        updateNavigationState();
    }

    // Add route button handlers
    document.querySelectorAll('.add-route-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const discipline = this.closest('section').id.split('-')[0];
            addNewRow(discipline);
        });
    });

    // Add CSS for error state
    const style = document.createElement('style');
    style.textContent = `
        .error {
            border-color: red !important;
            background-color: #fff0f0 !important;
        }
        .error:focus {
            border-color: red !important;
            box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.2) !important;
        }
    `;
    document.head.appendChild(style);
  }); // Close DOMContentLoaded event listener
</script>
{% endblock %}