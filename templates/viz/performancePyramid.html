{% extends "viz/base_viz.html" %}

{% block title %}Performance Pyramid{% endblock %}

{% block page_title %}Performance Pyramid Analysis{% endblock %}

{% block head_scripts %}
<!-- Load visualization scripts first -->
<script src="{{ url_for('static', filename='js/d3_viz/performancePyramid.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3_viz/projectsTable.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
  {% block data_vars %}
  <script>
    // Initialize data with proper JSON parsing
    var sportPyramidData = {{ sport_pyramid| tojson | safe }};
    var tradPyramidData = {{ trad_pyramid| tojson | safe }};
    var boulderPyramidData = {{ boulder_pyramid| tojson | safe }};
    var userTicksData = {{ user_ticks| tojson | safe }};
    var binnedCodeDict = {{ binned_code_dict| tojson | safe }};

    // Debug logs
    console.log('Data loaded:', {
      sport: {
        type: typeof sportPyramidData,
        length: sportPyramidData?.length,
        sample: sportPyramidData?.[0]
      },
      trad: {
        type: typeof tradPyramidData,
        length: tradPyramidData?.length,
        sample: tradPyramidData?.[0]
      },
      boulder: {
        type: typeof boulderPyramidData,
        length: boulderPyramidData?.length,
        sample: boulderPyramidData?.[0]
      }
    });
  </script>
  {% endblock %}

  <section class="dashboard-section">
    <!-- Filters Row -->
    <div class="viz-filters">
      <div class="viz-filter-section">
        <h3>Discipline</h3>
        <div class="viz-radio-group">
          <input type="radio" id="filter-pyramid-sport" name="performance-pyramid-discipline-filter" value="sport"
            checked />
          <label for="filter-pyramid-sport">Sport</label>
          <input type="radio" id="filter-pyramid-trad" name="performance-pyramid-discipline-filter" value="trad" />
          <label for="filter-pyramid-trad">Trad</label>
          <input type="radio" id="filter-pyramid-boulder" name="performance-pyramid-discipline-filter"
            value="boulder" />
          <label for="filter-pyramid-boulder">Boulder</label>
        </div>
      </div>

      <div class="viz-filter-section">
        <h3>Time Range</h3>
        <div class="viz-radio-group">
          <input type="radio" id="filter-pyramid-allTime" name="performance-pyramid-time-filter" value="allTime"
            checked />
          <label for="filter-pyramid-allTime">All Time</label>
          <input type="radio" id="filter-pyramid-pastYear" name="performance-pyramid-time-filter" value="lastYear" />
          <label for="filter-pyramid-pastYear">Past Year</label>
          <input type="radio" id="filter-pyramid-lastSixMonths" name="performance-pyramid-time-filter"
            value="lastSixMonths" />
          <label for="filter-pyramid-lastSixMonths">Last 6mo.</label>
        </div>
      </div>

      <div class="viz-filter-section">
        <h3>Goal Pyramid</h3>
        <div class="viz-radio-group">
          <input type="radio" id="filter-pyramid-conservative" name="pyramid-pace" value="conservative" />
          <label for="filter-pyramid-conservative"
            title="Wide base, gradual progression [1, 3, 6, 12, 24]">Conservative</label>
          <input type="radio" id="filter-pyramid-normal" name="pyramid-pace" value="normal" checked />
          <label for="filter-pyramid-normal" title="Balanced progression [1, 3, 5, 8, 16]">Normal</label>
          <input type="radio" id="filter-pyramid-fast" name="pyramid-pace" value="fast" />
          <label for="filter-pyramid-fast" title="Narrow base, rapid progression [1, 3, 4, 6, 9]">Fast</label>
        </div>
      </div>
    </div>

    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Performance Pyramid
          <button class="info-button" onclick="openPyramidModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
        <a href="{{ url_for('main.pyramid_input') }}" class="edit-button">
          <i class="fas fa-edit"></i>
          Edit Performance Data
        </a>
      </div>
    </div>

    <!-- Visualization Container -->
    <div class="viz-container" id="performance-pyramid"></div>

    <!-- Projects Table Section -->
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Active Projects
          <button class="info-button" onclick="openProjectsModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
    </div>

    <div class="projects-table-container">
      <table id="projects-table" class="data-table">
        <thead>
          <tr>
            <th>Route</th>
            <th>Grade</th>
            <th>Location</th>
            <th>Days Projected</th>
            <th>Total Attempts</th>
            <th>Last Attempted</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Info Modals -->
    {% include 'viz/modals/pyramid_info_modal.html' %}
    {% include 'viz/modals/projects_info_modal.html' %}
  </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Initialize visualization when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof pyramidVizChart === "function" && typeof projectsTable === "function") {
      // Initialize pyramid visualization
      pyramidVizChart("#performance-pyramid", {
        sport: sportPyramidData,
        trad: tradPyramidData,
        boulder: boulderPyramidData
      }, userTicksData, binnedCodeDict);

      // Initialize projects table
      projectsTable("#projects-table", userTicksData);

      // Add filter event listeners
      addFilterEventListeners();
    } else {
      console.error("Required visualization functions not loaded");
    }
  });

  function addFilterEventListeners() {
    // Discipline filter
    document.querySelectorAll('input[name="performance-pyramid-discipline-filter"]')
      .forEach(input => input.addEventListener('change', updateVisualization));

    // Time range filter
    document.querySelectorAll('input[name="performance-pyramid-time-filter"]')
      .forEach(input => input.addEventListener('change', updateVisualization));

    // Pyramid pace filter
    document.querySelectorAll('input[name="pyramid-pace"]')
      .forEach(input => input.addEventListener('change', updateVisualization));
  }

  function updateVisualization() {
    if (typeof pyramidVizChart === "function") {
      pyramidVizChart("#performance-pyramid", {
        sport: sportPyramidData,
        trad: tradPyramidData,
        boulder: boulderPyramidData
      }, userTicksData, binnedCodeDict);
    }
  }

  // Modal functions
  function openPyramidModal() {
    document.getElementById("pyramidModal").style.display = "block";
  }

  function closePyramidModal() {
    document.getElementById("pyramidModal").style.display = "none";
  }

  function openProjectsModal() {
    document.getElementById("projectsModal").style.display = "block";
  }

  function closeProjectsModal() {
    document.getElementById("projectsModal").style.display = "none";
  }

  // Close modals when clicking outside
  window.onclick = function (event) {
    const modals = ["pyramidModal", "projectsModal"];
    modals.forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
  };
</script>
{% endblock %}