{% extends "viz/base_viz.html" %}

{% block title %}Base Volume{% endblock %}

{% block page_title %}Base Volume Analysis{% endblock %}

{% block head_scripts %}
<!-- Load visualization scripts first -->
<script src="{{ url_for('static', filename='js/d3_viz/restDays.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3_viz/totalVert.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3_viz/workCapacity.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
  {% block data_vars %}
  <script>
    // Initialize data with proper JSON parsing using tojson filter
    var userTicksData = {{ user_ticks|tojson|safe }};
    var binnedCodeDict = {{ binned_code_dict|tojson|safe }};

    // Debug logs
    console.log('User Ticks Data:', {
      type: typeof userTicksData,
      isArray: Array.isArray(userTicksData),
      length: userTicksData?.length,
      sample: userTicksData?.[0]
    });

    console.log('Binned Code Dict:', {
      type: typeof binnedCodeDict,
      isArray: Array.isArray(binnedCodeDict),
      length: binnedCodeDict?.length,
      sample: binnedCodeDict?.[0]
    });
  </script>
  {% endblock %}

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Total Vertical Feet Climbed
          <button class="info-button" onclick="openDataInfoModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
      <div class="viz-filters">
        <div class="viz-filter-section">
          <h3>Discipline</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-vert-all" name="total-vert-discipline-filter" value="all" checked />
            <label for="filter-vert-all">All</label>
            <input type="radio" id="filter-vert-sport" name="total-vert-discipline-filter" value="sport" />
            <label for="filter-vert-sport">Sport</label>
            <input type="radio" id="filter-vert-trad" name="total-vert-discipline-filter" value="trad" />
            <label for="filter-vert-trad">Trad</label>
            <input type="radio" id="filter-vert-boulder" name="total-vert-discipline-filter" value="boulder" />
            <label for="filter-vert-boulder">Boulder</label>
          </div>
        </div>
        <div class="viz-filter-section">
          <h3>Time Range</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-vert-time-allTime" name="total-vert-time-filter" value="allTime" checked />
            <label for="filter-vert-time-allTime">All Time</label>
            <input type="radio" id="filter-vert-time-lastYear" name="total-vert-time-filter" value="lastYear" />
            <label for="filter-vert-time-lastYear">Past Year</label>
          </div>
        </div>
      </div>
    </div>

    <div class="viz-container" id="total-vert"></div>

    <!-- Data Info Modal -->
    <div id="dataInfoModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeDataInfoModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About Total Vertical</h3>
        </div>
        <div class="modal-section">
          <h4>Calculation Method</h4>
          <p>
            This visualization tracks your cumulative vertical feet climbed over time. The calculation includes all logged
            climbs
            from your Mountain Project tick list, taking into account both single-pitch and multi-pitch routes.
          </p>
        </div>
        <div class="modal-section">
          <h4>Route Types</h4>
          <ul>
            <li><strong>Single Pitch:</strong> Length Ã— Number of Ascents</li>
            <li><strong>Multi-pitch:</strong> Total Route Length (preserving actual vertical gain)</li>
            <li><strong>Boulder:</strong> Standard 15ft height per problem</li>
          </ul>
        </div>
        <div class="modal-section">
          <h4>Missing Data Handling</h4>
          <p>When route length is unavailable, we estimate using:</p>
          <ul>
            <li>Average length of other routes climbed that day</li>
            <li>If no daily average: 60ft per pitch for routes</li>
          </ul>
        </div>
        <div class="modal-section">
          <h4>Milestone Reference Lines</h4>
          <p>
            The dashed lines represent notable climbing and height milestones, from single pitches to famous peaks.
            Achieved
            milestones appear in gray, while upcoming goals are highlighted in blue.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Work Capacity
          <button class="info-button" onclick="openWorkCapacityModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
      <div class="viz-filters">
        <div class="viz-filter-section">
          <h3>Discipline</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-capacity-all" name="work-capacity-discipline-filter" value="all" checked />
            <label for="filter-capacity-all">All</label>
            <input type="radio" id="filter-capacity-sport" name="work-capacity-discipline-filter" value="sport" />
            <label for="filter-capacity-sport">Sport</label>
            <input type="radio" id="filter-capacity-trad" name="work-capacity-discipline-filter" value="trad" />
            <label for="filter-capacity-trad">Trad</label>
            <input type="radio" id="filter-capacity-boulder" name="work-capacity-discipline-filter" value="boulder" />
            <label for="filter-capacity-boulder">Boulder</label>
          </div>
        </div>
        <div class="viz-filter-section">
          <h3>Time Range</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-capacity-time-allTime" name="work-capacity-time-filter" value="allTime"
              checked />
            <label for="filter-capacity-time-allTime">All Time</label>
            <input type="radio" id="filter-capacity-time-lastYear" name="work-capacity-time-filter" value="lastYear" />
            <label for="filter-capacity-time-lastYear">Past Year</label>
          </div>
        </div>
      </div>
    </div>

    <div class="viz-container" id="work-capacity"></div>

    <!-- Work Capacity Info Modal -->
    <div id="workCapacityModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeWorkCapacityModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About the Data Calculations</h3>
        </div>
        <div class="modal-section">
          <h4>Daily Volume</h4>
          <p>
            This chart shows the average daily vertical feet climbed for each season. For routes with multiple ascents in
            a day,
            the total vertical is multiplied by the number of pitches climbed.
          </p>
        </div>
        <div class="modal-section">
          <h4>Route Types</h4>
          <p>Routes are calculated differently based on their type:</p>
          <ul>
            <li>Multipitch routes: Total route length is used when available. If length is missing, estimated as 80ft per
              pitch.</li>
            <li>Sport routes: 80ft per pitch if length is missing</li>
            <li>Trad routes: 100ft per pitch if length is missing</li>
            <li>Boulder problems: 10ft per ascent if height is missing</li>
          </ul>
        </div>
        <div class="modal-section">
          <h4>Missing Length Data</h4>
          <p>
            When a route's length is not available, we first try to calculate an average based on other routes climbed
            that day.
            If no other routes were climbed that day, we use the default lengths listed above.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Days Outside Per Week
          <button class="info-button" onclick="openDaysOutsideModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
      <div class="viz-filters">
        <div class="viz-filter-section">
          <h3>Discipline</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-rest-all" name="rest-days-discipline-filter" value="all" checked />
            <label for="filter-rest-all">All</label>
            <input type="radio" id="filter-rest-sport" name="rest-days-discipline-filter" value="sport" />
            <label for="filter-rest-sport">Sport</label>
            <input type="radio" id="filter-rest-trad" name="rest-days-discipline-filter" value="trad" />
            <label for="filter-rest-trad">Trad</label>
            <input type="radio" id="filter-rest-boulder" name="rest-days-discipline-filter" value="boulder" />
            <label for="filter-rest-boulder">Boulder</label>
          </div>
        </div>
        <div class="viz-filter-section">
          <h3>Time Range</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-rest-time-allTime" name="rest-days-time-filter" value="allTime" checked />
            <label for="filter-rest-time-allTime">All Time</label>
            <input type="radio" id="filter-rest-time-lastYear" name="rest-days-time-filter" value="lastYear" />
            <label for="filter-rest-time-lastYear">Past Year</label>
            <input type="radio" id="filter-rest-time-lastSixMonths" name="rest-days-time-filter" value="lastSixMonths" />
            <label for="filter-rest-time-lastSixMonths">Last 6mo.</label>
          </div>
        </div>
      </div>
    </div>

    <div class="viz-container" id="rest-days"></div>

    <!-- Days Outside Info Modal -->
    <div id="daysOutsideModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeDaysOutsideModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About the Data Calculations</h3>
        </div>
        <div class="modal-section">
          <h4>Weekly Average Calculation</h4>
          <p>
            This chart shows your average days of outdoor climbing per week, broken down by month. For each month, we
            count your
            unique climbing days and divide by the number of weeks in that month.
          </p>
        </div>
        <div class="modal-section">
          <h4>Seasonal Colors</h4>
          <p>The bars are colored by season to show patterns in your climbing:</p>
          <ul>
            <li>Spring (Light Green): March - May</li>
            <li>Summer (Dark Green): June - August</li>
            <li>Fall (Orange-Brown): September - November</li>
            <li>Winter (Blue-Gray): December - February</li>
          </ul>
          <p>The gray portion represents the remaining days of the week.</p>
        </div>
        <div class="modal-section">
          <h4>Statistics</h4>
          <p>The chart includes two key statistics:</p>
          <ul>
            <li>Average Days/Week: Your mean climbing frequency across the entire period</li>
            <li>Total Days: The total number of unique days you climbed outdoors</li>
          </ul>
        </div>
        <div class="modal-section">
          <h4>Filtering</h4>
          <p>You can filter the data by:</p>
          <ul>
            <li>Discipline: All climbing, Sport only, Trad only, or Boulder only</li>
            <li>Time Range: All time, Past year, or Last 6 months</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Modal functions
  const modalFunctions = {
    openDataInfoModal() {
      document.getElementById("dataInfoModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeDataInfoModal() {
      document.getElementById("dataInfoModal").style.display = "none";
      document.body.style.overflow = "auto";
    },

    openWorkCapacityModal() {
      document.getElementById("workCapacityModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeWorkCapacityModal() {
      document.getElementById("workCapacityModal").style.display = "none";
      document.body.style.overflow = "auto";
    },

    openDaysOutsideModal() {
      document.getElementById("daysOutsideModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeDaysOutsideModal() {
      document.getElementById("daysOutsideModal").style.display = "none";
      document.body.style.overflow = "auto";
    }
  };

  // Assign modal functions to window for onclick handlers
  Object.assign(window, modalFunctions);

  // Close modals when clicking outside
  window.onclick = function (event) {
    const modals = ["dataInfoModal", "workCapacityModal", "daysOutsideModal"];
    modals.forEach((modalId) => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });
  };

  // Function to initialize charts
  function initCharts() {
    if (userTicksData && userTicksData.length > 0) {
      // Initialize charts
      restDaysChart("#rest-days", userTicksData);
      totalVertChart("#total-vert", userTicksData);
      workCapacityChart("#work-capacity", userTicksData, binnedCodeDict);

      // Add event listeners to filters
      d3.selectAll("input[name='rest-days-discipline-filter']").on("change", function () {
        restDaysChart("#rest-days", userTicksData);
      });
      d3.selectAll("input[name='rest-days-time-filter']").on("change", function () {
        restDaysChart("#rest-days", userTicksData);
      });
      d3.selectAll("input[name='total-vert-discipline-filter']").on("change", function () {
        totalVertChart("#total-vert", userTicksData);
      });
      d3.selectAll("input[name='total-vert-time-filter']").on("change", function () {
        totalVertChart("#total-vert", userTicksData);
      });
      d3.selectAll("input[name='work-capacity-discipline-filter']").on("change", function () {
        workCapacityChart("#work-capacity", userTicksData);
      });
      d3.selectAll("input[name='work-capacity-time-filter']").on("change", function () {
        workCapacityChart("#work-capacity", userTicksData);
      });
    } else {
      console.warn('No visualization data available');
      document.querySelectorAll('.viz-container').forEach(container => {
        container.innerHTML = '<div class="alert alert-warning">No climbing data available to visualize.</div>';
      });
    }
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initCharts);
</script>
{% endblock %}