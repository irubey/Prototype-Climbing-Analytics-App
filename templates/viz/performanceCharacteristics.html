{% extends "viz/base_viz.html" %}

{% block title %}Performance Characteristics{% endblock %}

{% block page_title %}Route Characteristics Analysis{% endblock %}

{% block head_scripts %}
<!-- Load visualization scripts first -->
<script src="{{ url_for('static', filename='js/d3_viz/performanceCharacteristics.js') }}" 
  onerror="console.error('Failed to load visualization script')"
  defer></script>
{% endblock %}

{% block content %}
<div class="container">
  {% block data_vars %}
  <script>
    // Debug log raw data from server
    console.log('Raw data from server:', {
      sport_pyramid: {{ sport_pyramid| tojson | safe }},
      trad_pyramid: {{ trad_pyramid| tojson | safe }},
      boulder_pyramid: {{ boulder_pyramid| tojson | safe }},
      binned_code_dict: {{ binned_code_dict| tojson | safe }}
    });

    try {
      // Initialize data with proper JSON parsing and make globally accessible
      window.sportPyramidData = {{ sport_pyramid| tojson | safe }};
      window.tradPyramidData = {{ trad_pyramid| tojson | safe }};
      window.boulderPyramidData = {{ boulder_pyramid| tojson | safe }};
      window.binnedCodeDict = {{ binned_code_dict| tojson | safe }};

      // Debug logs for data initialization
      console.log('Data initialization:', {
        sport: {
          type: typeof window.sportPyramidData,
          isArray: Array.isArray(window.sportPyramidData),
          length: window.sportPyramidData?.length,
          sample: window.sportPyramidData?.[0]
        },
        trad: {
          type: typeof window.tradPyramidData,
          isArray: Array.isArray(window.tradPyramidData),
          length: window.tradPyramidData?.length,
          sample: window.tradPyramidData?.[0]
        },
        boulder: {
          type: typeof window.boulderPyramidData,
          isArray: Array.isArray(window.boulderPyramidData),
          length: window.boulderPyramidData?.length,
          sample: window.boulderPyramidData?.[0]
        },
        binnedCodes: {
          type: typeof window.binnedCodeDict,
          isArray: Array.isArray(window.binnedCodeDict),
          length: window.binnedCodeDict?.length,
          sample: window.binnedCodeDict?.[0]
        }
      });
    } catch (error) {
      console.error('Error initializing data:', error);
    }
  </script>
  {% endblock %}

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Route Analysis
          <button class="info-button" onclick="openCharacteristicsModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
        <a href="{{ url_for('main.pyramid_input') }}" class="edit-button">
          <i class="fas fa-edit"></i>
          Edit Performance Data
        </a>
      </div>

      <div class="viz-filters">
        <div class="viz-filter-section">
          <h3>Discipline</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-performance-sport" name="characteristics-discipline-filter" value="sport"
              checked />
            <label for="filter-performance-sport">Sport</label>
            <input type="radio" id="filter-performance-trad" name="characteristics-discipline-filter" value="trad" />
            <label for="filter-performance-trad">Trad</label>
            <input type="radio" id="filter-performance-boulder" name="characteristics-discipline-filter"
              value="boulder" />
            <label for="filter-performance-boulder">Boulder</label>
          </div>
        </div>

        <div class="viz-filter-section">
          <h3>Time Range</h3>
          <div class="viz-radio-group">
            <input type="radio" id="filter-performance-time-allTime" name="characteristics-time-filter" value="allTime"
              checked />
            <label for="filter-performance-time-allTime">All Time</label>
            <input type="radio" id="filter-performance-time-lastYear" name="characteristics-time-filter"
              value="lastYear" />
            <label for="filter-performance-time-lastYear">Past Year</label>
            <input type="radio" id="filter-performance-time-lastSixMonths" name="characteristics-time-filter"
              value="lastSixMonths" />
            <label for="filter-performance-time-lastSixMonths">Last 6mo.</label>
            <input type="radio" id="filter-performance-time-lastThreeMonths" name="characteristics-time-filter"
              value="lastThreeMonths" />
            <label for="filter-performance-time-lastThreeMonths">Last 3mo.</label>
          </div>
        </div>
      </div>
    </div>

    <div class="viz-container" id="performance-characteristics"></div>

    <!-- Info Modal -->
    {% include 'viz/modals/characteristics_info_modal.html' %}
  </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Initialize visualization when DOM is loaded
  document.addEventListener("DOMContentLoaded", function() {
    if (typeof window.characteristicsVizChart === "function") {
      const data = window.determineData();
      window.characteristicsVizChart("#performance-characteristics", data.pyramidData, window.binnedCodeDict);
    } else {
      console.error("Required visualization functions not loaded");
      const container = document.querySelector('#performance-characteristics');
      if (container) {
        container.innerHTML = '<div class="alert alert-warning">Visualization is not available. Please try refreshing the page.</div>';
      }
    }
  });

  function addFilterEventListeners() {
    // Discipline filter
    document.querySelectorAll('input[name="characteristics-discipline-filter"]')
      .forEach(input => input.addEventListener('change', updateVisualization));

    // Time range filter
    document.querySelectorAll('input[name="characteristics-time-filter"]')
      .forEach(input => input.addEventListener('change', updateVisualization));
  }

  function updateVisualization() {
    if (typeof window.characteristicsVizChart === "function") {
      const data = window.determineData();
      window.characteristicsVizChart("#performance-characteristics", data.pyramidData, window.binnedCodeDict);
    }
  }

  // Modal functions
  function openCharacteristicsModal() {
    document.getElementById("characteristicsModal").style.display = "block";
  }

  function closeCharacteristicsModal() {
    document.getElementById("characteristicsModal").style.display = "none";
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    const modal = document.getElementById("characteristicsModal");
    if (event.target === modal) {
      modal.style.display = "none";
    }
  };
</script>
{% endblock %}