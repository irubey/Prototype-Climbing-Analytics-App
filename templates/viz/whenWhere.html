{% extends "viz/base_viz.html" %}

{% block title %}When and Where{% endblock %}

{% block page_title %}Climbing Location Analysis{% endblock %}

{% block head_scripts %}
<!-- Load visualization scripts first -->
<script src="{{ url_for('static', filename='js/d3_viz/locationRace.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3_viz/locationTree.js') }}"></script>
<script src="{{ url_for('static', filename='js/d3_viz/seasonalHeatmap.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
  {% block data_vars %}
  <script>
    // Initialize data with proper JSON parsing using tojson filter
    var userTicksData = {{ user_ticks|tojson|safe }};

    // Debug logs
    console.log('User Ticks Data:', {
      type: typeof userTicksData,
      isArray: Array.isArray(userTicksData),
      length: userTicksData?.length,
      sample: userTicksData?.[0]
    });
  </script>
  {% endblock %}

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Location Distribution - Pitch Count
          <button class="info-button" onclick="openLocationModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
    </div>

    <div class="viz-container" id="location-race"></div>

    <!-- Location Distribution Info Modal -->
    <div id="locationModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeLocationModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About the Data Calculations</h3>
        </div>
        <div class="modal-section">
          <h4>Location Tracking</h4>
          <p>
            This visualization shows the distribution of your climbing areas over time, tracking how many days you've
            spent at each location.
          </p>
        </div>
        <div class="modal-section">
          <h4>Area Grouping</h4>
          <p>
            Locations are grouped by their primary climbing area and state/region to show your most frequently visited
            climbing destinations.
          </p>
        </div>
        <div class="modal-section">
          <h4>Time Analysis</h4>
          <p>
            The progression shows how your climbing locations have evolved, highlighting when you started climbing at new
            areas.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Location Tree
          <button class="info-button" onclick="openTreeModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
    </div>

    <div class="viz-container" id="location-tree"></div>

    <!-- Location Tree Info Modal -->
    <div id="treeModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeTreeModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About the Location Tree</h3>
        </div>
        <div class="modal-section">
          <h4>Hierarchical View</h4>
          <p>
            This radial tree visualization displays your climbing locations in a hierarchical structure, with the root
            node "All Locations" at the center. Branches spread outward to show states/regions, areas, and specific climbing
            locations.
          </p>
        </div>
        <div class="modal-section">
          <h4>Visual Elements</h4>
          <p>
            Node sizes decrease with depth - root and state-level nodes are larger than more specific locations. Colors
            indicate different states/regions, and branches are arranged counterclockwise with higher percentage locations
            appearing first.
          </p>
        </div>
        <div class="modal-section">
          <h4>Interaction</h4>
          <p>
            Hover over any node or legend item to highlight that branch and its connections. The tooltip shows location
            details, including the number of pitches climbed and the percentage of climbing done relative to its parent location.
          </p>
        </div>
      </div>
    </div>
  </section>

  <section class="dashboard-section">
    <div class="viz-header">
      <div class="viz-title">
        <h2>
          Seasonal Climbing Patterns
          <button class="info-button" onclick="openHeatmapModal()">
            <i class="fas fa-info-circle"></i>
          </button>
        </h2>
      </div>
    </div>

    <div class="viz-container" id="seasonal-heatmap"></div>
    <div id="heatmap-tooltip" class="tooltip"></div>

    <!-- Heatmap Info Modal -->
    <div id="heatmapModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeHeatmapModal()">
          <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
          <h3>About the Seasonal Heatmap</h3>
        </div>
        <div class="modal-section">
          <h4>Visualization Overview</h4>
          <p>
            This heatmap shows your climbing intensity across months and years. Darker colors indicate more pitches
            climbed.
          </p>
        </div>
        <div class="modal-section">
          <h4>Reading the Data</h4>
          <p>
            Each cell represents a month, with color intensity showing the number of pitches climbed. Hover over cells to
            see detailed information.
          </p>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Modal functions
  const modalFunctions = {
    openLocationModal() {
      document.getElementById("locationModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeLocationModal() {
      document.getElementById("locationModal").style.display = "none";
      document.body.style.overflow = "auto";
    },

    openTreeModal() {
      document.getElementById("treeModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeTreeModal() {
      document.getElementById("treeModal").style.display = "none";
      document.body.style.overflow = "auto";
    },

    openHeatmapModal() {
      document.getElementById("heatmapModal").style.display = "block";
      document.body.style.overflow = "hidden";
    },

    closeHeatmapModal() {
      document.getElementById("heatmapModal").style.display = "none";
      document.body.style.overflow = "auto";
    }
  };

  // Assign modal functions to window for onclick handlers
  Object.assign(window, modalFunctions);

  // Close modals when clicking outside
  window.onclick = function (event) {
    const modals = ["locationModal", "treeModal", "heatmapModal"];
    modals.forEach((modalId) => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }
    });
  };

  // Function to initialize charts
  function initCharts() {
    if (userTicksData && userTicksData.length > 0) {
      // Initialize charts
      locationRaceChart(userTicksData, "#location-race");
      locationTreeChart(userTicksData, "#location-tree");
      seasonalHeatmap(userTicksData, "#seasonal-heatmap");
    } else {
      console.warn('No visualization data available');
      document.querySelectorAll('.viz-container').forEach(container => {
        container.innerHTML = '<div class="alert alert-warning">No climbing data available to visualize.</div>';
      });
    }
  }

  // Initialize on DOM ready
  document.addEventListener("DOMContentLoaded", initCharts);
</script>
{% endblock %}