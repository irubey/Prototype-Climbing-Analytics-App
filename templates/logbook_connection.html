<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      defer
      src="https://www.googletagmanager.com/gtag/js?id=G-QLKC35PVJB"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-QLKC35PVJB");
    </script>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta
      name="description"
      content="SendSage - Where climbing wisdom meets data. Let our sage analytics transform your Mountain Project data into enlightened insights for your climbing journey."
    />
    <meta name="theme-color" content="#2a4f5f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />

    <title>SendSage | Climbing Analytics</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ url_for('static', filename='images/brand/favicon-32x32.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ url_for('static', filename='images/brand/favicon-16x16.png') }}"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="{{ url_for('static', filename='images/brand/apple-touch-icon.png') }}"
    />

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Preload loading screen images -->
    <link
      rel="preload"
      as="image"
      fetchpriority="high"
      href="{{ url_for('static', filename='images/loading1.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading2.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading3.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading4.jpg') }}"
    />
    <link
      rel="preload"
      as="image"
      href="{{ url_for('static', filename='images/loading5.jpg') }}"
    />

    <!-- Load fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
    />

    <!-- Load CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/_landingPage.css') }}"
    />
  </head>
  <body>
    <div class="background-overlay"></div>
    <div class="container">
      <main class="content-wrapper spacing-responsive" role="main">
        <div class="main-content user-viz">
          <h1 class="text-sm-center text-md-left" tabindex="0">
            SendSage - Visualized logbook
            <br />
            <span class="subtitle">Seek Climbing Wisdom Through Data</span>
          </h1>

          <div class="social-proof" aria-live="polite">
            <div class="user-count-wrapper">
              <span class="user-count-label"
                >Join your
                <span class="user-count" id="userCount">-</span> fellow climbers
                analyzing their data</span
              >
            </div>
          </div>

          <div class="input-container">
            <form
              action="{{ url_for('main.logbook_connection') }}"
              method="POST"
              id="profileForm"
              class="grid grid-cols"
            >
              {{ form.csrf_token }}
              <div class="form-group">
                {{ form.profile_url(
                  class="spacing-responsive form-control",
                  placeholder="Paste Mtn. Project Profile URL",
                  autocomplete="off",
                  autocapitalize="off",
                  spellcheck="false",
                  id="profileInput",
                  required="required",
                  value=request.form.get('profile_url', '')
                ) }}
              </div>
              {% if form.profile_url.errors %}
              <div class="error-message" id="errorMessage" role="alert" aria-live="polite">
                {% for error in form.profile_url.errors %}
                  {{ error }}
                {% endfor %}
              </div>
              {% else %}
              <div class="error-message" id="errorMessage" role="alert" aria-live="polite" style="display: none;"></div>
              {% endif %}
              <div class="button-group grid grid-cols">
                <button type="submit" class="primary-button" id="submitButton" name="submit">Analyze</button>
                <button
                  type="button"
                  class="secondary-button"
                  id="demoButton"
                  onclick="tryDemo()"
                  aria-label="Try demo analysis"
                >
                  <span class="button-text">Try Demo</span>
                  <span class="loading-spinner" aria-hidden="true"></span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>

      <footer>
        <nav class="footer-links">
          <a href="/contact" class="footer-link">Contact</a>
          <a href="/terms" class="footer-link">Terms</a>
          <a href="/privacy" class="footer-link">Privacy</a>
        </nav>
      </footer>
    </div>

    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      style="display: none"
      role="dialog"
      aria-label="Loading progress"
    >
      <div class="loading-overlay"></div>
      <div class="loading-content">
        <div class="loading-header">
          <h2 tabindex="0">Analyzing Your Climbing</h2>
          <div class="loading-icon">
            <div class="spinner" aria-hidden="true"></div>
          </div>
        </div>

        <div class="loading-stages">
          <div class="stage" id="stage1">
            <div class="stage-dot" aria-hidden="true"></div>
            <span>Fetching data</span>
          </div>
          <div class="stage" id="stage2">
            <div class="stage-dot" aria-hidden="true"></div>
            <span>Processing routes</span>
          </div>
          <div class="stage" id="stage3">
            <div class="stage-dot" aria-hidden="true"></div>
            <span>Building metrics</span>
          </div>
          <div class="stage" id="stage4">
            <div class="stage-dot" aria-hidden="true"></div>
            <span>Preparing viz</span>
          </div>
        </div>

        <div
          class="progress-container"
          role="progressbar"
          aria-valuemin="0"
          aria-valuemax="100"
        >
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
          <p class="loading-status">Processing your data...</p>
        </div>
      </div>
    </div>

    <script>
      let isLoading = false;
      let currentStage = 0;
      const stages = ["stage1", "stage2", "stage3", "stage4"];
      const stageDelay = 2000; // 2 seconds per stage

      // Add function to fetch and display user count
      async function fetchUserCount() {
        try {
          const response = await fetch("/api/support-count");
          const data = await response.json();
          const userCountElement = document.getElementById("userCount");
          userCountElement.textContent = data.count.toLocaleString();
        } catch (error) {
          console.error("Error fetching user count:", error);
        }
      }

      // Fetch user count when page loads
      document.addEventListener("DOMContentLoaded", fetchUserCount);

      function setLoading(loading) {
        isLoading = loading;
        document.getElementById("submitButton").classList.toggle("loading", loading);
        document.getElementById("demoButton").classList.toggle("loading", loading);
        document.getElementById("profileInput").disabled = loading;

        // Update ARIA states
        document.getElementById("submitButton").setAttribute("aria-busy", loading);
        document.getElementById("demoButton").setAttribute("aria-busy", loading);
      }

      function updateLoadingStages() {
        if (currentStage < stages.length) {
          const stageElement = document.getElementById(stages[currentStage]);
          stageElement.classList.add("active");
          stageElement.setAttribute("aria-current", "step");
          currentStage++;

          // Update progress bar
          const progress = (currentStage / stages.length) * 100;
          document.querySelector(".progress-container").setAttribute("aria-valuenow", progress);
        }
      }

      function showLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        loadingScreen.style.display = "flex";
        loadingScreen.setAttribute("aria-hidden", "false");
        currentStage = 0;
        stages.forEach((stage) => {
          const element = document.getElementById(stage);
          element.classList.remove("active");
          element.removeAttribute("aria-current");
        });
        document.querySelector(".progress-fill").style.width = "100%";
        updateLoadingStages();
      }

      function hideLoadingScreen() {
        const loadingScreen = document.getElementById("loadingScreen");
        loadingScreen.style.display = "none";
        loadingScreen.setAttribute("aria-hidden", "true");
        document.querySelector(".progress-fill").style.width = "0";
        currentStage = 0;
        stages.forEach((stage) => {
          const element = document.getElementById(stage);
          element.classList.remove("active");
          element.removeAttribute("aria-current");
        });
      }

      document.getElementById("profileForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission
        
        if (isLoading) {
          return;
        }
        
        const profileInput = document.getElementById("profileInput");
        const profileUrl = profileInput.value.trim();
        
        if (!profileUrl) {
          const errorMessage = document.getElementById("errorMessage");
          errorMessage.textContent = "Please enter a Mountain Project profile URL";
          errorMessage.style.display = "block";
          profileInput.classList.add("error");
          profileInput.setAttribute("aria-invalid", "true");
          return;
        }
        
        // Create FormData object
        const formData = new FormData(event.target);
        formData.set('profile_url', profileUrl); // Ensure profile_url is set
        
        // Submit the form
        setLoading(true);
        showLoadingScreen();
        
        fetch("{{ url_for('main.logbook_connection') }}", {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            return response.text().then(html => {
              document.documentElement.innerHTML = html;
            });
          }
        })
        .catch(error => {
          console.error('Error:', error);
          hideLoadingScreen();
          setLoading(false);
          const errorMessage = document.getElementById("errorMessage");
          errorMessage.textContent = "An error occurred. Please try again.";
          errorMessage.style.display = "block";
        });
      });

      async function tryDemo() {
        try {
          showLoadingScreen();
          const response = await fetch('/demo-login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (response.redirected) {
            window.location.href = response.url;
          } else {
            const result = await response.json();
            if (result.error) throw new Error(result.error);
          }
        } catch (error) {
          hideLoadingScreen();
          showError(error.message);
        }
      }

      // Remove error state when user starts typing
      document.getElementById("profileInput").addEventListener("input", function() {
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.style.display = "none";
        this.classList.remove("error");
        this.removeAttribute("aria-invalid");
      });
    </script>
    <script src="{{ url_for('static', filename='js/loadingScreen.js') }}"></script>
  </body>
</html>
